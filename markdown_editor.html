<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Markdown Editor with LaTeX</title>
  
  <!-- MathJax Configuration -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$']],
        displayMath: [['$$', '$$']],
        processEscapes: true,
        packages: ['base', 'ams'],
      },
      svg: {
        fontCache: 'local',
      }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

  <!-- Marked.js -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- DOMPurify -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.4/dist/purify.min.js"></script>
  
  <!-- Highlight.js Stylesheets -->
  <link id="highlightStyle" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css">
  
  <!-- Highlight.js Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  
  <!-- Initialize Highlight.js after DOM content is loaded -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      hljs.highlightAll();
    });
  </script>

  <style>
    :root {
      /* -------------------------------
         CSS Variables for Theme and Layout
      --------------------------------- */
      --background-color: #ffffff;
      --text-color: #000000;
      --pane-background: #ffffff;
      --pane-heading-background: #333333;
      --pane-heading-color: #ffffff;
      --button-background: #f0f0f0;
      --button-color: #000000;
      --border-color: #ccc;
      --code-background: #f0f0f0;
      --table-border-color: black;
      --table-header-background: #f4f4f4;

      /* -------------------------------
         CSS Variables for Toggle Switch
      --------------------------------- */
      --switch-width: 42px;               /* Width of the switch */
      --switch-height: 18px;              /* Height of the switch */
      --slider-size: 13px;                /* Size of the toggle knob */
      --slider-transform: 23px;           /* Distance the knob moves when toggled */
      --switch-active-color: #009688;     /* Active background color of the switch */
      --switch-background-color: #ccc;    /* Inactive background color of the switch */
      --switch-knob-color: white;         /* Color of the toggle knob */
      --switch-label-font-size: 14px;     /* Font size of the switch label */
    }

    body.dark-mode {
      --background-color: #1e1e1e;
      --text-color: #e0e0e0;
      --pane-background: #1e1e1e;
      --pane-heading-background: #2d2c2c;
      --pane-heading-color: #ffffff;
      --button-background: #474646;
      --button-color: #ffffff;
      --border-color: #555555;
      --code-background: #2f2f2f; /* Darker background for code blocks */
      --table-border-color: #555555;
      --table-header-background: #333333;
      --code-text-color: #f8f8f2; /* Brightened code text color */
      /* Toggle Switch Active Color in Dark Mode */
      --switch-active-color: #009688; /* Teal remains consistent */
    }

    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
      margin: 0;
      font-family: Helvetica, sans-serif;
      line-height: 1.5; /* Set line-height to 1.5 */
      background-color: var(--background-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }

    #editorContainer {
      display: flex;
      flex: 1;
      background-color: var(--pane-background);
      height: 100%;
      border-top: 0px solid var(--border-color);
      border-bottom: 0px solid var(--border-color);
    }

    body.dark-mode #editorContainer {
      background-color: var(--pane-background);
    }

    #inputPane, #outputPane {
      width: 50%;
      padding: 0;
      box-sizing: border-box;
      background-color: var(--pane-background);
      display: flex;
      flex-direction: column;
      min-height: 0;
      border: none;
    }

    #inputPane {
      border-right: 1px solid var(--border-color);
    }

    .pane-heading-container {
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      background-color: var(--pane-heading-background);
      color: var(--pane-heading-color);
      margin: 0;
      padding: 5px;
      text-align: center;
    }

    .pane-heading-container h2 {
      margin: 0;
      flex: 1;
    }

    .theme-toggle-button {
      position: absolute;
      right: 10px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 18px;
      color: var(--pane-heading-color);
    }

    .buttonContainer {
      margin: 10px 0;
      text-align: center;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    body.dark-mode .buttonContainer button {
      background-color: var(--button-background);
      color: var(--button-color);
      border: none;
    }

    /* ----------------------------------------
       Toggle Switch Container and Styles
    ------------------------------------------- */
    /* Toggle Switch Container */
    .toggle-container {
      position: absolute;
      right: 15px; /* Adjust spacing from the edge as needed */
      display: flex;
      align-items: center;
    }

    /* Toggle Switch Styles */
    .switch {
      position: relative;
      display: inline-block;
      width: var(--switch-width);  /* Width of the switch */
      height: var(--switch-height); /* Height of the switch */
      margin-left: 2px; /* Adjust spacing between label and switch */
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--switch-background-color); /* Inactive background color */
      transition: 0.4s;
      border-radius: calc(var(--switch-height) / 2); /* Fully rounded corners */
    }

    .slider:before {
      position: absolute;
      content: "";
      height: var(--slider-size); /* Size of the toggle knob */
      width: var(--slider-size);   /* Size of the toggle knob */
      left: 2.5px; /* Adjust position as needed */
      bottom: 2.5px; /* Adjust position as needed */
      background-color: var(--switch-knob-color); /* Color of the toggle knob */
      transition: 0.4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--switch-active-color); /* Active background color */
    }

    input:focus + .slider {
      box-shadow: 0 0 1px var(--switch-active-color); /* Focus shadow */
    }

    input:checked + .slider:before {
      transform: translateX(var(--slider-transform)); /* Move knob when checked */
    }

    /* Style for the Sync Scroll Label */
    .switch-label {
      font-size: var(--switch-label-font-size); /* Font size of the label */
      margin-right: 5px; /* Space between label and switch */
    }

    textarea {
      flex: 1;
      width: 100%;
      padding: 20px;
      border: none;
      resize: none;
      font-size: 16px;
      line-height: 1.5;
      box-sizing: border-box;
      overflow-y: auto;
      background-color: var(--pane-background);
      color: var(--text-color);
    }

    #renderedOutput {
      flex: 1;
      padding: 20px;
      font-size: 16px;
      line-height: 1.5; /* Consistent line-height */
      box-sizing: border-box;
      overflow-y: auto;
      background-color: var(--pane-background);
      color: var(--text-color);
    }

    /* Inline code styling */
    code {
      background-color: var(--code-background);
      padding: 0.1em 0.2em;
      border-radius: 3px;
      font-size: 0.95em; /* Set font size to 0.95em */
      line-height: 1; /* Maintain tight spacing for inline code */
      font-family: "Courier New", Courier, monospace;
      vertical-align: baseline;
      color: inherit; /* Inherit color to allow Highlight.js to apply */
    }

    /* Code block styling */
    pre {
      background-color: var(--code-background);
      padding: 0; /* Removed padding */
      border-radius: 5px;
      overflow-x: auto;
      font-size: 0.95em; /* Set font size to 0.95em */
      line-height: 1.5; /* Set line-height to 1.5 */
      margin: 2px 0; /* Further reduced margin */
    }

    pre code {
      background: none; /* Let Highlight.js handle background */
      padding: 0; /* Removed padding */
      border-radius: 0;
      font-family: inherit; /* Inherit font from pre */
      line-height: 1.5; /* Ensure line-height is applied */
      font-size: inherit; /* Inherit font size */
      color: inherit; /* Inherit color to allow Highlight.js to apply */
    }

    /* Highlight.js Styles */
    .hljs {
      line-height: 1.5; /* Ensure Highlight.js respects line-height */
      font-size: 0.95em; /* Match the font size of pre */
      background-color: inherit; /* Ensure background is inherited from pre */
      color: inherit; /* Inherit color to allow custom coloring */
    }

    /* Custom Highlight.js Colors for Dark Mode */
    body.dark-mode .hljs {
      color: var(--code-text-color); /* Brightened code text color */
    }

    body.dark-mode .hljs-comment,
    body.dark-mode .hljs-quote {
      color: #8d9a70 !important; /* Darker green for comments */
    }

    body.dark-mode .hljs-keyword,
    body.dark-mode .hljs-selector-tag,
    body.dark-mode .hljs-subst {
      color: #66d9ef !important; /* Bright blue for keywords */
    }

    body.dark-mode .hljs-string,
    body.dark-mode .hljs-doctag {
      color: #e6db74 !important; /* Yellow for strings */
    }

    body.dark-mode .hljs-number,
    body.dark-mode .hljs-regexp,
    body.dark-mode .hljs-tag .hljs-attr {
      color: #ae81ff !important; /* Purple for numbers and attributes */
    }

    body.dark-mode .hljs-title,
    body.dark-mode .hljs-section {
      color: #a6e22e !important; /* Green for titles and sections */
    }

    body.dark-mode .hljs-type,
    body.dark-mode .hljs-built_in {
      color: #fd971f !important; /* Orange for types and built-ins */
    }

    body.dark-mode .hljs-symbol,
    body.dark-mode .hljs-bullet {
      color: #f92672 !important; /* Pink for symbols and bullets */
    }

    body.dark-mode .hljs-link {
      color: #e6db74 !important; /* Yellow for links */
    }

    /* Add more .hljs-* styles as needed based on the Highlight.js theme */

    /* Updated table styles */
    table {
      max-width: 90%;
      margin: 20px auto;
      border-collapse: collapse;
      border: 1px solid var(--table-border-color);
    }

    th, td {
      border: 1px solid var(--table-border-color);
      padding: 8px;
      /* Removed fixed alignment */
      /* text-align: left; */
    }

    /* Alignment based on the 'align' attribute */
    th[align="left"], td[align="left"] {
      text-align: left;
    }

    th[align="center"], td[align="center"] {
      text-align: center;
    }

    th[align="right"], td[align="right"] {
      text-align: right;
    }

    /* Optional: Default alignment if 'align' attribute is not specified */
    th, td {
      text-align: left; /* You can set a default alignment if desired */
    }

    /* Highlight.js Styles in Print */
    @media print {
      /* Override CSS Variables to Light Mode */
      :root {
        --background-color: #ffffff !important;
        --text-color: #000000 !important;
        --pane-background: #ffffff !important;
        --pane-heading-background: #333333 !important;
        --pane-heading-color: #ffffff !important;
        --button-background: #f0f0f0 !important;
        --button-color: #000000 !important;
        --border-color: #ccc !important;
        --code-background: #f0f0f0 !important;
        --table-border-color: black !important;
        --table-header-background: #f4f4f4 !important;
        /* Toggle Switch Variables */
        --switch-active-color: #009688 !important;
        --switch-background-color: #ccc !important;
        --switch-knob-color: white !important;
        --switch-label-font-size: 18px !important;
      }

      /* Ensure body uses light mode colors */
      body {
        background-color: #ffffff !important;
        color: #000000 !important;
        line-height: 1.5 !important;
      }

      #editorContainer {
        display: block;
      }

      #inputPane {
        display: none;
      }

      #outputPane {
        width: auto !important;
        padding: 15mm !important;
        background-color: #ffffff !important;
        color: #000000 !important;
        border: none !important;
        line-height: 1.5 !important;
      }

      /* Hide the entire pane heading container */
      .pane-heading-container {
        display: none !important;
        margin: 0 !important;
        padding: 0 !important;
      }

      /* Hide elements with 'no-print' class */
      .no-print {
        display: none !important;
      }

      svg, pre {
        page-break-inside: avoid !important;
        line-height: 1.5 !important;
      }

      #renderedOutput {
        font-size: 14pt !important;
        line-height: 1.5 !important;
      }

      /* Hide the footer when printing */
      footer {
        display: none !important;
      }

      /* Page Break Support */
      .page-break {
        display: block;              /* Ensure the div is rendered */
        page-break-after: always;    /* Insert a page break after this div */
        height: 0;                   /* Prevent the div from taking up space */
      }

      /* Ensure MathJax equations are black in print */
      svg {
        color: #000000 !important; /* Sets the text color to black */
        stroke: #000000 !important; /* Ensures box outlines like \boxed remain visible */
      }

      /* Preserve Highlight.js styles in print */
      pre {
        background-color: #f0f0f0 !important; /* Ensure background is visible */
        line-height: 1.5 !important; /* Ensure line-height is set */
        font-size: 0.95em !important; /* Ensure font size is consistent */
        margin: 2px 0 !important; /* Ensure reduced margin is applied */
      }

      /* Ensure code colors are preserved */
      .hljs {
        color: #000000 !important;
        line-height: 1.5 !important; /* Ensure line-height is set */
        font-size: 0.95em !important; /* Ensure font size is consistent */
        background-color: inherit !important; /* Inherit background */
      }

      .hljs-comment,
      .hljs-quote {
        color: #008000 !important; /* Example: green for comments */
      }

      /* Add more .hljs-* styles as needed based on the Highlight.js theme */

      /* Alignment based on the 'align' attribute in print */
      th[align="left"], td[align="left"] {
        text-align: left !important;
      }

      th[align="center"], td[align="center"] {
        text-align: center !important;
      }

      th[align="right"], td[align="right"] {
        text-align: right !important;
      }

      /* Optional: Default alignment in print */
      th, td {
        text-align: left !important; /* Set a default alignment if no 'align' attribute is present */
      }
    }

    footer {
      text-align: center;
      padding: 5px;
      background: #f4f4f4;
      color: #555;
      margin-top: 5px;
    }

    body.dark-mode footer {
      background: #2d2c2c;
      color: #ccc;
    }

    /* Original Button Styles */
    button {
      margin: 5px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      background-color: var(--button-background);
      color: var(--button-color);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      transition: background-color 0.3s, color 0.3s;
    }

    button:hover {
      opacity: 0.8;
    }
  </style>

</head>
<body>
  <div id="editorContainer">
    <div id="inputPane">
      <div class="pane-heading-container">
        <h2 class="pane-heading">Markdown Input</h2>
      </div>
      <div class="buttonContainer">
        <button id="loadFileButton">Load .md File</button>
        <button id="saveMDButton">Save as .md</button>
        <button id="clearButton">Clear Input</button>
        <button id="loadSampleButton">Load Sample Document</button>
      </div>
      <textarea id="markdownInput" placeholder="Type your Markdown and LaTeX here..."></textarea>
    </div>
    <div id="outputPane">
      <div class="pane-heading-container">
        <h2 class="pane-heading">Rendered Output</h2>
        <button id="themeToggleButton" class="theme-toggle-button no-print" aria-label="Switch to Dark Mode" title="Switch to Dark Mode">☀️</button>
      </div>
      <div class="buttonContainer no-print">
        <button id="printButton" title="Prints in light mode">Print to PDF</button>
        <button id="exportHTMLButton" title="Exports in current theme">Export as HTML</button>
        
        <!-- Toggle Switch for Sync Scroll -->
        <div class="toggle-container">
          <label for="syncScrollSwitch" class="switch-label">Sync Scroll</label>
          <label class="switch">
            <input type="checkbox" id="syncScrollSwitch">
            <span class="slider"></span>
          </label>
        </div>
      </div>
      <div id="renderedOutput"></div>
    </div>
  </div>

  <footer>
    &copy; 2024 PanPhy. All rights reserved.
  </footer>

  <script>
    const markdownInput = document.getElementById('markdownInput');
    const renderedOutput = document.getElementById('renderedOutput');
    const clearButton = document.getElementById('clearButton');
    const loadSampleButton = document.getElementById('loadSampleButton');
    const exportHTMLButton = document.getElementById('exportHTMLButton');
    const printButton = document.getElementById('printButton');
    const saveMDButton = document.getElementById('saveMDButton');
    const loadFileButton = document.getElementById('loadFileButton');
    const themeToggleButton = document.getElementById('themeToggleButton');
    const highlightStyle = document.getElementById('highlightStyle');
    const syncScrollSwitch = document.getElementById('syncScrollSwitch');

    // Define sampleDocument using String.raw to preserve backslashes
    const sampleDocument = String.raw`
# Welcome to the Markdown & LaTeX Playground! 🎉

Ever felt like your document is missing a little *sparkle*? ✨ Tired of clicking countless buttons to format your tables or hunting for symbols in hidden dropdown menus? This editor is your new best friend. Dive in, unleash your creativity, and watch your documents transform from "meh" to "magnificent"! Happy editing! 📝🚀

<br>

---

# This is a demo of...

1. a bit of **Markdown**,  
2. a tiny little bit of **LaTeX**, and  
3. a few **HTML** tags.

---

## 1. Markdown

**1.1 Headings**
> # ⚠️This is a HUGE Heading!
> ### This is not as HUGE~~ Phew 😙!

**1.2 Lists**
- Let's make a list in a list in a list...
    1. Item One ✔️
    2. Item Two ✔️  
        - I can **bold** it.  
        - I can ~~strikethrough~~ it.  
- I can *italicize* it. _And so can I!_

**1.3 Blockquotes**
> This is a quotation. 
>> And this is a quotation within a quotation. *Because why not?*

**1.4 Code Blocks**

~~~python
# I can type my codes here.

for i in range(5):
    print(i)
    i = i * 2  # Doubling the fun!
~~~

**1.5 Tables**

| Name   | Age | Profession |
|:---|:---:|---:|
| Eddard | 35 | Lord 🐺 |
| Albus  | 115 | Wizard 🧙‍♂️|
| Tony   | 38 | Inventor 🤖 |


> (*Did you notice the fancy text alignment I gave each column?*)

**1.6 Links**

- 1.6.1 **Inline Link:**  
> I can insert a [link](https://www.youtube.com) that takes you to the land of endless dog videos. 🐶

- 1.6.2 **Reference Links:**
  - *"[Markdown][1] is a lightweight markup language for creating formatted text using a plain-text editor."*
  
  - *"[LaTeX][2] is widely used in academia for the communication and publication of scientific documents and technical note-taking in many fields, owing partially to its support for complex mathematical notation."*

---

## 2. LaTeX

**2.1 Greek Letters**
> *In case you need more symbols...*
>> $\alpha \space \beta \space \lambda \space \Lambda \space \theta \space \Omega$

>> $\mu_\tau^\alpha \quad \nu \quad \tau \quad \epsilon \quad \psi \quad \rho \quad g_{\mu\nu}$  

**2.2 Math Expressions**

- 2.2.1. **Inline Examples:**
> This is an $\alpha$, and this is a $\beta$. Absolute zero is $-273 ^\circ{C}$ 🥶.  

- 2.2.2. **Displayed Examples:**

$$ \frac{1}{x} $$

$$ \boxed{M_\odot^2} $$

$$ x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a} $$

$$ \int_{t=-\infty}^{\infty} \ln \frac{1}{t^e} dt $$

$$ \ddot{x} = \frac{d \dot{x}}{dt} = \frac{d^2x}{dt^2} $$

$$ \left. \frac{\partial{y}}{\partial{t}} \right|_{t=5} $$

$$ \vec{\nabla} \cdot D = \left| \vec{\nabla} \times \vec{A} \right| $$

$$ {\lim_{\Delta x \to 0}}  \frac{f(x + \Delta x) - f(x)}{\Delta x} $$

|Note
|:---
It doesn't make sense to me...😑 <br/> However, you need to type <code>\lim\limits_{\Delta x \to 0}</code> for a correct inline version $ \lim\limits_{\Delta x \to 0} $. Note the additional <code>\lim</code> is only required for the inline version.

- 2.2.3. **Matrices**

$$
\begin{pmatrix}
a & b & c \\
d & e & f \\
g & h & i \\
\end{pmatrix}
\cdot
\begin{vmatrix}
a & b \\
c & d \\
\end{vmatrix} =
\begin{bmatrix}
\alpha_{11} & \alpha_{12} & \alpha_{13} \\
\alpha_{21} & \alpha_{22} & \alpha_{23} \\
\alpha_{31} & \alpha_{32} & \alpha_{33} \\
\end{bmatrix}
$$

- 2.2.4. **Equation Alignment**

$$
\begin{aligned}
ax^2 + b^2 + c &= 0 \\
x &= \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}
\end{aligned}
$$

- 2.2.5. **Bracket Size**

$$ \left( \frac{1}{\sqrt[n]{2}} \right) \space \text{vs} \space ( \frac{1}{\sqrt[n]{2}} ) $$

> (*Because size does matter... sometimes.*)

**2.3 Chemical Equations**

$$
{Na_{(aq)}}^+ + {Cl_{(aq)}}^- \longrightarrow NaCl_{(s)}
$$

> *🧪 Chemistry deserves some LaTeX love too.*

---

## 3. HTML
(*Because even Markdown needs a little HTML magic.*)

**3.1 Page Break**
- Want to start a new page in your printed PDF? Just add the following line wherever you’d like a fresh page to begin! 📃

> <code> \<div class="page-break"\>\<\/div\> </code>

> (Don't worry! It does nothing in the exported HTML! 😉)

<div class="page-break"></div>

**3.2 Line Break**
- Can you find the line breaks I made with <code>\<br\></code> in this doc?

<br>

**3.3 Inserting Pictures** (and their alignment)
- Let's insert a picture below...

<p align="center">
    <img src="https://panphy.github.io/sample_pic.webp" width="250" alt="Made with ChatGPT">
</p>

<p align="center">
    Fig. 1 - This is the caption. What a nice picture!
</p>

---

**And there you have it! 🏆**

A whimsical tour through **Markdown**, **LaTeX**, and **HTML**. May your documents be ever stylish and your equations ever solvable!

[1]: https://en.wikipedia.org/wiki/Markdown "Markdown"  
[2]: https://en.wikipedia.org/wiki/LaTeX "LaTeX"
  `;

    /**
     * Preprocess the input Markdown by replacing all single backslashes with double backslashes
     * within LaTeX math blocks. This ensures that LaTeX commands requiring backslashes are
     * correctly interpreted by MathJax without affecting other parts of the Markdown content.
     * 
     * @param {string} input - The raw Markdown input from the user.
     * @returns {string} - The processed Markdown with escaped backslashes in LaTeX blocks.
     */
    function preprocessMarkdown(input) {
      // Regex to match inline ($...$) and display ($$...$$) math blocks
      const regex = /(\$\$?)([\s\S]+?)\1/g;
      return input.replace(regex, function(match, p1, p2) {
        // Replace single backslashes with double backslashes within LaTeX blocks
        const escaped = p2.replace(/\\/g, '\\\\');
        return p1 + escaped + p1;
      });
    }

    function renderContent() {
      const inputText = markdownInput.value;
      const preprocessedText = preprocessMarkdown(inputText);

      // Configure Marked to add language classes and use Highlight.js for syntax highlighting
      marked.setOptions({
        gfm: true, // Enable GitHub Flavored Markdown
        headerIds: true, // Enable header IDs
        tables: true, // Ensure tables are enabled
        langPrefix: 'hljs language-', // Highlight.js expects a top-level 'hljs' class
        highlight: function(code, lang) {
          if (lang && hljs.getLanguage(lang)) {
            return hljs.highlight(code, { language: lang }).value;
          } else {
            return hljs.highlightAuto(code).value;
          }
        }
      });

      const parsedMarkdown = marked.parse(preprocessedText);
      const sanitizedContent = DOMPurify.sanitize(parsedMarkdown);
      renderedOutput.innerHTML = sanitizedContent;
      
      // Apply syntax highlighting to the newly added code blocks
      hljs.highlightAll();

      // Re-apply MathJax after rendering
      MathJax.typesetPromise([renderedOutput]).catch(console.error);
    }

    async function printToPDF() {
      // Remove dark-mode class temporarily to enforce light mode in print
      const body = document.body;
      const hadDarkMode = body.classList.contains('dark-mode');
      if (hadDarkMode) {
        body.classList.remove('dark-mode');
      }

      // Ensure Highlight.js uses light theme during print
      highlightStyle.href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css';

      // Ensure MathJax has finished rendering
      await MathJax.typesetPromise([renderedOutput]);

      // Re-apply Highlight.js before printing
      hljs.highlightAll();

      window.print();

      // Re-add dark-mode class after printing if it was present
      if (hadDarkMode) {
        body.classList.add('dark-mode');
        // Re-apply the dark theme for Highlight.js
        highlightStyle.href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/monokai.min.css';
        updateThemeToggleButton(); // Update the toggle button icon and attributes
      }
    }

    function exportHTML() {
      const fileName = prompt('Enter file name for the HTML export:', 'document.html');
      if (!fileName) return;

      const sanitizedHTML = renderedOutput.innerHTML;
      const doc = document.implementation.createHTMLDocument('Exported Document');
      const head = doc.head;
      const body = doc.body;

      // Add meta charset
      const meta = document.createElement('meta');
      meta.setAttribute('charset', 'UTF-8');
      head.appendChild(meta);

      // Add title
      const title = document.createElement('title');
      title.textContent = 'Exported Document';
      head.appendChild(title);

      // Add custom styles
      const style = document.createElement('style');
      style.textContent = `
        :root {
          --background-color: #ffffff;
          --text-color: #000000;
          --pane-background: #ffffff;
          --pane-heading-background: #333333;
          --pane-heading-color: #ffffff;
          --button-background: #f0f0f0;
          --button-color: #000000;
          --border-color: #ccc;
          --code-background: #f0f0f0;
          --table-border-color: black;
          --table-header-background: #f4f4f4;
          /* CSS Variables for Toggle Switch */
          --switch-width: 43px;
          --switch-height: 20px;
          --slider-size: 15px;
          --slider-transform: 23px;
          --switch-active-color: #009688; /* Teal */
          --switch-background-color: #ccc;
          --switch-knob-color: white;
          --switch-label-font-size: 18px;
        }

        body.dark-mode {
          --background-color: #1e1e1e;
          --text-color: #e0e0e0;
          --pane-background: #1e1e1e;
          --pane-heading-background: #2d2c2c;
          --pane-heading-color: #ffffff;
          --button-background: #474646;
          --button-color: #ffffff;
          --border-color: #555555;
          --code-background: #2f2f2f;
          --table-border-color: #555555;
          --table-header-background: #333333;
          --code-text-color: #f8f8f2; /* Brightened code text color */
          /* Toggle Switch Active Color in Dark Mode */
          --switch-active-color: #009688; /* Teal remains consistent */
        }

        body {
          font-family: Helvetica, sans-serif;
          line-height: 1.5; /* Consistent line-height */
          margin: 20px;
          background-color: var(--background-color);
          color: var(--text-color);
        }
        /* Ensure all elements inherit background and text colors */
        body, div, p, h1, h2, h3, h4, h5, h6, pre, code, table, th, td, blockquote {
          background-color: var(--background-color);
          color: var(--text-color);
        }

        table {
          max-width: 90%;
          margin: 20px auto;
          border-collapse: collapse;
          border: 1px solid var(--table-border-color);
        }

        th, td {
          border: 1px solid var(--table-border-color);
          padding: 8px;
        }

        /* Alignment based on the 'align' attribute */
        th[align="left"], td[align="left"] {
          text-align: left;
        }

        th[align="center"], td[align="center"] {
          text-align: center;
        }

        th[align="right"], td[align="right"] {
          text-align: right;
        }

        /* Optional: Default alignment if 'align' attribute is not specified */
        th, td {
          text-align: left; /* You can set a default alignment if desired */
        }

        code {
          background-color: var(--code-background);
          padding: 0.1em 0.2em;
          border-radius: 3px;
          font-size: 0.95em;
          line-height: 1;
          font-family: "Courier New", Courier, monospace;
          vertical-align: baseline;
          color: inherit;
        }

        pre {
          background-color: var(--code-background);
          padding: 0;
          border-radius: 5px;
          overflow-x: auto;
          font-size: 1.05em;
          line-height: 1.5;
          margin: 2px 0;
        }

        pre code {
          background: none;
          padding: 0;
          border-radius: 0;
          font-family: inherit;
          line-height: 1.5;
          font-size: inherit;
          color: inherit;
        }

        .hljs {
          line-height: 1.5;
          font-size: 1.05em;
          background-color: inherit;
          color: inherit;
        }

        /* Custom Highlight.js Colors for Dark Mode */
        body.dark-mode .hljs {
          color: #f8f8f2 !important;
        }

        body.dark-mode .hljs-comment,
        body.dark-mode .hljs-quote {
          color: #8d9a70 !important;
        }

        body.dark-mode .hljs-keyword,
        body.dark-mode .hljs-selector-tag,
        body.dark-mode .hljs-subst {
          color: #66d9ef !important;
        }

        body.dark-mode .hljs-string,
        body.dark-mode .hljs-doctag {
          color: #e6db74 !important;
        }

        body.dark-mode .hljs-number,
        body.dark-mode .hljs-regexp,
        body.dark-mode .hljs-tag .hljs-attr {
          color: #ae81ff !important;
        }

        body.dark-mode .hljs-title,
        body.dark-mode .hljs-section {
          color: #a6e22e !important;
        }

        body.dark-mode .hljs-type,
        body.dark-mode .hljs-built_in {
          color: #fd971f !important;
        }

        body.dark-mode .hljs-symbol,
        body.dark-mode .hljs-bullet {
          color: #f92672 !important;
        }

        body.dark-mode .hljs-link {
          color: #e6db74 !important;
        }

        /* Add more .hljs-* styles as needed based on the Highlight.js theme */

        /* Inline styles for images to maintain alignment */
        img {
          max-width: 100%;
          height: auto;
        }
      `; // Custom styles end
      head.appendChild(style);

      // Add Highlight.js Stylesheet based on current theme
      const isDarkMode = document.body.classList.contains('dark-mode');
      const highlightLink = document.createElement('link');
      highlightLink.rel = 'stylesheet';
      if (isDarkMode) {
        // Use a dark theme for Highlight.js, e.g., monokai
        highlightLink.href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/monokai.min.css';
      } else {
        // Use the default light theme
        highlightLink.href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css';
      }
      head.appendChild(highlightLink);

      // Add Highlight.js Library
      const highlightScript = document.createElement('script');
      highlightScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js';
      head.appendChild(highlightScript);

      // Add Highlight.js Initialization Script
      const highlightInit = document.createElement('script');
      highlightInit.textContent = `
        window.addEventListener('DOMContentLoaded', () => {
          hljs.highlightAll();
        });
      `;
      head.appendChild(highlightInit);

      // Add MathJax Configuration
      const mathjaxConfigScript = document.createElement('script');
      mathjaxConfigScript.textContent = `
        window.MathJax = {
          tex: {
            inlineMath: [['$', '$']],
            displayMath: [['$$', '$$']],
            processEscapes: true,
            packages: ['base', 'ams'],
          },
          svg: {
            fontCache: 'local',
          }
        };
      `;
      head.appendChild(mathjaxConfigScript);

      // Add MathJax Script
      const mathjaxScript = document.createElement('script');
      mathjaxScript.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js';
      head.appendChild(mathjaxScript);

      // Insert the sanitized HTML content
      body.innerHTML = sanitizedHTML;

      // Apply dark-mode class if active
      if (isDarkMode) {
        body.classList.add('dark-mode');
      }

      // Construct the full HTML
      const exportedHTML = `<!DOCTYPE html>${doc.documentElement.outerHTML}`;
      const blob = new Blob([exportedHTML], { type: 'text/html' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = fileName;
      link.click();
    }

    function saveMarkdown() {
      const fileName = prompt('Enter file name for the Markdown file:', 'document.md');
      if (!fileName) return;

      const blob = new Blob([markdownInput.value], { type: 'text/markdown' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = fileName;
      link.click();
    }

    function loadMarkdownFile() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.md,text/markdown';
      input.onchange = e => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = event => {
            markdownInput.value = event.target.result;
            renderContent();
          };
          reader.readAsText(file);
        }
      };
      input.click();
    }

    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      if (document.body.classList.contains('dark-mode')) {
        themeToggleButton.textContent = '🌙';
        themeToggleButton.setAttribute('aria-label', 'Switch to Light Mode');
        themeToggleButton.setAttribute('title', 'Switch to Light Mode');
        // Change Highlight.js stylesheet to dark theme
        highlightStyle.href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/monokai.min.css';
      } else {
        themeToggleButton.textContent = '☀️';
        themeToggleButton.setAttribute('aria-label', 'Switch to Dark Mode');
        themeToggleButton.setAttribute('title', 'Switch to Dark Mode');
        // Change Highlight.js stylesheet to default light theme
        highlightStyle.href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css';
      }
    }

    function updateThemeToggleButton() {
      if (document.body.classList.contains('dark-mode')) {
        themeToggleButton.textContent = '🌙';
        themeToggleButton.setAttribute('aria-label', 'Switch to Light Mode');
        themeToggleButton.setAttribute('title', 'Switch to Light Mode');
      } else {
        themeToggleButton.textContent = '☀️';
        themeToggleButton.setAttribute('aria-label', 'Switch to Dark Mode');
        themeToggleButton.setAttribute('title', 'Switch to Dark Mode');
      }
    }

    // Event Listeners
    markdownInput.addEventListener('input', renderContent);
    printButton.addEventListener('click', printToPDF);
    exportHTMLButton.addEventListener('click', exportHTML);
    saveMDButton.addEventListener('click', saveMarkdown);
    loadFileButton.addEventListener('click', loadMarkdownFile);
    loadSampleButton.addEventListener('click', () => {
      markdownInput.value = sampleDocument;
      renderContent();
    });
    clearButton.addEventListener('click', () => {
      markdownInput.value = '';
      renderContent();
    });
    themeToggleButton.addEventListener('click', toggleTheme);

    // Initialize Sync Scroll based on the toggle's initial state
    let isSyncScrollEnabled = syncScrollSwitch.checked;

    // Flags to prevent infinite scroll loops
    let isSyncingInputScroll = false;
    let isSyncingOutputScroll = false;

    // Toggle Scroll Sync Functionality
    syncScrollSwitch.addEventListener('change', () => {
      isSyncScrollEnabled = syncScrollSwitch.checked;
    });

    /**
     * Throttle function to limit the rate at which a function can fire.
     * @param {Function} func - The function to throttle.
     * @param {number} limit - The time limit in milliseconds.
     * @returns {Function}
     */
    function throttle(func, limit) {
      let inThrottle;
      return function() {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
          func.apply(context, args);
          inThrottle = true;
          setTimeout(() => inThrottle = false, limit);
        }
      }
    }

    /**
     * Synchronized Scrolling: Input to Output
     */
    const syncInputToOutput = throttle(() => {
      if (!isSyncScrollEnabled || isSyncingInputScroll) return;

      isSyncingOutputScroll = true;

      requestAnimationFrame(() => {
        const inputScrollTop = markdownInput.scrollTop;
        const inputScrollHeight = markdownInput.scrollHeight - markdownInput.clientHeight;
        const outputScrollHeight = renderedOutput.scrollHeight - renderedOutput.clientHeight;

        // Prevent division by zero
        if (inputScrollHeight === 0) {
          renderedOutput.scrollTop = 0;
        } else {
          const scrollRatio = inputScrollTop / inputScrollHeight;
          const newOutputScrollTop = scrollRatio * outputScrollHeight;
          if (Math.abs(renderedOutput.scrollTop - newOutputScrollTop) > 1) { // prevent unnecessary updates
            renderedOutput.scrollTop = newOutputScrollTop;
          }
        }

        isSyncingOutputScroll = false;
      });
    }, 16); // Approximately 60fps

    /**
     * Synchronized Scrolling: Output to Input
     */
    const syncOutputToInput = throttle(() => {
      if (!isSyncScrollEnabled || isSyncingOutputScroll) return;

      isSyncingInputScroll = true;

      requestAnimationFrame(() => {
        const outputScrollTop = renderedOutput.scrollTop;
        const outputScrollHeight = renderedOutput.scrollHeight - renderedOutput.clientHeight;
        const inputScrollHeight = markdownInput.scrollHeight - markdownInput.clientHeight;

        // Prevent division by zero
        if (outputScrollHeight === 0) {
          markdownInput.scrollTop = 0;
        } else {
          const scrollRatio = outputScrollTop / outputScrollHeight;
          const newInputScrollTop = scrollRatio * inputScrollHeight;
          if (Math.abs(markdownInput.scrollTop - newInputScrollTop) > 1) { // prevent unnecessary updates
            markdownInput.scrollTop = newInputScrollTop;
          }
        }

        isSyncingInputScroll = false;
      });
    }, 16); // Approximately 60fps

    // Attach scroll event listeners with passive option
    markdownInput.addEventListener('scroll', syncInputToOutput, { passive: true });
    renderedOutput.addEventListener('scroll', syncOutputToInput, { passive: true });

    // Print Event Handlers to Switch Highlight.js Stylesheet
    window.addEventListener('beforeprint', () => {
      // Switch to light theme before printing
      highlightStyle.href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css';
    });

    window.addEventListener('afterprint', () => {
      // Revert to the current theme's Highlight.js stylesheet after printing
      if (document.body.classList.contains('dark-mode')) {
        highlightStyle.href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/monokai.min.css';
      } else {
        highlightStyle.href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css';
      }
    });

    // Initial render
    renderContent();
  </script>
</body>
</html>
