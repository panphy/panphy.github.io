<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Markdown Editor with LaTeX</title>
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$']],
        displayMath: [['$$', '$$']],
        processEscapes: true, // Keeping as true
        packages: ['base', 'ams'],
      },
      svg: {
        fontCache: 'local',
      }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.4/dist/purify.min.js"></script>
  <style>
    :root {
      --background-color: #ffffff;
      --text-color: #000000;
      --pane-background: #ffffff;
      --pane-heading-background: #333333;
      --pane-heading-color: #ffffff;
      --button-background: #f0f0f0;
      --button-color: #000000;
      --border-color: #ccc;
      --code-background: #f0f0f0;
      --table-border-color: black;
      --table-header-background: #f4f4f4;
    }

    body.dark-mode {
      --background-color: #1e1e1e;
      --text-color: #e0e0e0;
      --pane-background: #1e1e1e;
      --pane-heading-background: #2d2c2c;
      --pane-heading-color: #ffffff;
      --button-background: #474646;
      --button-color: #ffffff;
      --border-color: #555555;
      --code-background: #2c2c2c;
      --table-border-color: #555555;
      --table-header-background: #333333;
    }

    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
      margin: 0;
      font-family: Helvetica, sans-serif;
      line-height: 1.6;
      background-color: var(--background-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }

    #editorContainer {
      display: flex;
      flex: 1;
      background-color: var(--pane-background);
      height: 100%;
      border-top: 0px solid var(--border-color);
      border-bottom: 0px solid var(--border-color);
    }

    body.dark-mode #editorContainer {
      background-color: var(--pane-background);
    }

    #inputPane, #outputPane {
      width: 50%;
      padding: 0;
      box-sizing: border-box;
      background-color: var(--pane-background);
      display: flex;
      flex-direction: column;
      min-height: 0;
      border: none;
    }

    #inputPane {
      border-right: 1px solid var(--border-color);
    }

    .pane-heading-container {
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      background-color: var(--pane-heading-background);
      color: var(--pane-heading-color);
      margin: 0;
      padding: 5px;
      text-align: center;
    }

    .pane-heading-container h2 {
      margin: 0;
      flex: 1;
    }

    .theme-toggle-button {
      position: absolute;
      right: 10px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 18px;
      color: var(--pane-heading-color);
    }

    .buttonContainer {
      margin: 10px 0;
      text-align: center;
    }

    body.dark-mode .buttonContainer button {
      background-color: var(--button-background);
      color: var(--button-color);
      border: none;
    }

    textarea {
      flex: 1;
      width: 100%;
      padding: 20px;
      border: none;
      resize: none;
      font-size: 16px;
      line-height: 1.5;
      box-sizing: border-box;
      overflow-y: auto;
      background-color: var(--pane-background);
      color: var(--text-color);
    }

    #renderedOutput {
      flex: 1;
      padding: 20px;
      font-size: 16px;
      line-height: 1.5;
      box-sizing: border-box;
      overflow-y: auto;
      background-color: var(--pane-background);
      color: var(--text-color);
    }

    code {
      background-color: var(--code-background);
      padding: 0.1em 0.2em;
      border-radius: 3px;
      font-size: 0.95em;
      line-height: 1;
      font-family: "Courier New", Courier, monospace;
      vertical-align: baseline;
    }

    table {
      max-width: 90%;
      margin: 20px auto;
      border-collapse: collapse;
      border: 1px solid var(--table-border-color);
    }

    th, td {
      border: 1px solid var(--table-border-color);
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: var(--table-header-background);
      font-weight: bold;
    }

    button {
      margin: 5px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      background-color: var(--button-background);
      color: var(--button-color);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      transition: background-color 0.3s, color 0.3s;
    }

    button:hover {
      opacity: 0.8;
    }

    /* Hide the page-break div on screen */
    .page-break {
      display: none;
    }

    @media print {
      body {
        display: block;
        margin: 0;
        background-color: #ffffff !important;
        color: #000000 !important;
      }

      #editorContainer {
        display: block;
      }

      #inputPane {
        display: none;
      }

      #outputPane {
        width: auto;
        padding: 15mm;
        background-color: #ffffff !important;
        color: #000000 !important;
        border: none;
      }

      #outputPane .pane-heading,
      .no-print {
        display: none !important;
      }

      svg, pre {
        page-break-inside: avoid;
      }

      #renderedOutput {
        font-size: 14pt;
        line-height: 1.6;
      }

      /* Hide the footer when printing */
      footer {
        display: none;
      }

      /* Page Break Support */
      .page-break {
        display: block;              /* Ensure the div is rendered */
        page-break-after: always;    /* Insert a page break after this div */
        height: 0;                   /* Prevent the div from taking up space */
      }

      /* Ensure MathJax equations are black in print */
      svg {
        color: #000000 !important; /* Sets the text color to black */
        stroke: #000000 !important; /* Ensures box outlines like \boxed remain visible */
      }
    }

    footer {
      text-align: center;
      padding: 5px;
      background: #f4f4f4;
      color: #555;
      margin-top: 5px;
    }

    body.dark-mode footer {
      background: #2d2c2c;
      color: #ccc;
    }
  </style>
</head>
<body>
  <div id="editorContainer">
    <div id="inputPane">
      <div class="pane-heading-container">
        <h2 class="pane-heading">Markdown Input</h2>
      </div>
      <div class="buttonContainer">
        <button id="loadFileButton">Load .md File</button>
        <button id="saveMDButton">Save as .md</button>
        <button id="clearButton">Clear Input</button>
        <button id="loadSampleButton">Load Sample Document</button>
      </div>
      <textarea id="markdownInput" placeholder="Type your Markdown and LaTeX here..."></textarea>
    </div>
    <div id="outputPane">
      <div class="pane-heading-container">
        <h2 class="pane-heading">Rendered Output</h2>
        <button id="themeToggleButton" class="theme-toggle-button no-print" aria-label="Switch to Dark Mode" title="Switch to Dark Mode">‚òÄÔ∏è</button>
      </div>
      <div class="buttonContainer no-print">
        <button id="printButton">Print to PDF</button>
        <button id="exportHTMLButton">Export as HTML</button>
      </div>
      <div id="renderedOutput"></div>
    </div>
  </div>

  <footer>
    &copy; 2024 PanPhy. All rights reserved.
  </footer>

  <script>
    const markdownInput = document.getElementById('markdownInput');
    const renderedOutput = document.getElementById('renderedOutput');
    const clearButton = document.getElementById('clearButton');
    const loadSampleButton = document.getElementById('loadSampleButton');
    const exportHTMLButton = document.getElementById('exportHTMLButton');
    const printButton = document.getElementById('printButton');
    const saveMDButton = document.getElementById('saveMDButton');
    const loadFileButton = document.getElementById('loadFileButton');
    const themeToggleButton = document.getElementById('themeToggleButton');

    // Define sampleDocument using String.raw to preserve backslashes
    const sampleDocument = String.raw`
# Welcome to the Markdown & LaTeX Playground! üéâ

Ever felt like your document is missing a little *sparkle*? ‚ú® Tired of clicking countless buttons to format your tables or hunting for symbols in hidden dropdown menus? This editor is your new best friend. Dive in, unleash your creativity, and watch your documents transform from "meh" to "magnificent"! Happy editing! üìùüöÄ

<br>

---

# This is a demo of...

1. a bit of Markdown,  
2. a tiny little bit of LaTeX, and  
3. a few HTML tags.

---

## 1. Markdown

**1.1 Headings**
> # Warning: This is a HUGE Heading!
> ### This is Not as Huge~~ Phew üòô!

**1.2 Lists**
- Let's make a list in a list in a list...
    1. Item One ‚úîÔ∏è
    2. Item Two ‚úîÔ∏è  
        - I can **bold** it.  
        - I can ~~strikethrough~~ it.  
- I can *italicize* it. _And so can I!_

**1.3 Blockquotes**
> This is a quotation. 
>> And this is a quotation within a **quotation**. *Because why not?*

**1.4 Code Blocks**

~~~python
# I can type my codes here.

for i in range(5):
    print(i)
    i = i * 2  # Doubling the fun!
~~~

**1.5 Tables**

| Name | Age | Profession |
|:---:|:---:|:---:|
| Eddard | 35 | Lord üê∫ |
| Albus | 115 | Wizard üßô‚Äç‚ôÇÔ∏è|
| Tony | 38 | Inventor ü§ñ |

**1.6 Links**

- 1.5.1 **Inline Link:**  
> I can insert a [link](https://www.youtube.com) that takes you to the land of endless dog videos. üê∂

- 1.5.2 **Reference Links:**
  - *"[Markdown][1] is a lightweight markup language for creating formatted text using a plain-text editor."*
  
  - *"[LaTeX][2] is widely used in academia for the communication and publication of scientific documents and technical note-taking in many fields, owing partially to its support for complex mathematical notation."*

---

## 2. LaTeX

**2.1 Greek Letters**
> *In case you need more symbols...*
>> $\alpha \space \beta \space \lambda \space \Lambda \space \theta \space \Omega$

>> $\mu_\tau^\alpha \quad \nu \quad \tau \quad \epsilon \quad \psi \quad \rho \quad g_{\mu\nu}$  

**2.2 Math Expressions**

- 2.2.1. **Inline examples:**
> This is an $\alpha$, and this is a $\beta$. Absolute zero is $-273 ^\circ{C}$ ü•∂.  

- 2.2.2. **Displayed examples:**  

$$ \frac{1}{x} $$

$$ \boxed{M_\odot^2} $$

$$ x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a} $$

$$ \int_{t=-\infty}^{\infty} \ln \frac{1}{t^e} dt $$

$$ \ddot{x} = \frac{d \dot{x}}{dt} = \frac{d^2x}{dt^2} $$

$$ \left. \frac{\partial{y}}{\partial{t}} \right|_{t=5} $$

$$ \vec{\nabla} \cdot D = \left| \vec{\nabla} \times \vec{A} \right| $$

$$ {\lim_{\Delta x \to 0}}  \frac{f(x + \Delta x) - f(x)}{\Delta x} $$

|Note
|:---
It doesn't make sense to me...üòë But you need <code>\lim\limits_{\Delta x \to 0}</code> for inline $ \lim\limits_{\Delta x \to 0} $. Note the additional <code>\lim</code> in front of the original syntax.

- 2.2.3. **Matrices**

$$
\begin{pmatrix}
a & b & c \\
d & e & f \\
g & h & i \\
\end{pmatrix}
\cdot
\begin{vmatrix}
a & b \\
c & d \\
\end{vmatrix} =
\begin{bmatrix}
\alpha_{11} & \alpha_{12} & \alpha_{13} \\
\alpha_{21} & \alpha_{22} & \alpha_{23} \\
\alpha_{31} & \alpha_{32} & \alpha_{33} \\
\end{bmatrix}
$$

- 2.2.4. **Equation Alignment**

$$
\begin{aligned}
ax^2 + b^2 + c &= 0 \\
x &= \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}
\end{aligned}
$$

- 2.2.5. **Bracket Size**

$$ \left( \frac{1}{\sqrt[n]{2}} \right) \space \text{vs} \space ( \frac{1}{\sqrt[n]{2}} ) $$

> (*Because size does matter... sometimes.*)

**2.3 Chemical Equations**

$$
{Na_{(aq)}}^+ + {Cl_{(aq)}}^- \longrightarrow NaCl_{(s)}
$$

> *üß™ Chemistry deserves some LaTeX love too.*

---

## 3. Using HTML

(*Because even Markdown needs a little HTML magic.*)

- If you want to insert a page break in the printed PDF, insert this:

> <code> \<div class="page-break"\>\<\/div\> </code>

> (It is invisible in the HTML. üòâ)

<div class="page-break"></div>

- Can you find the line breaks I made with <code>\<br\></code> in this doc?

<br>

- Let's insert a picture!

<p align="center">
    <img src="https://panphy.github.io/sample_pic.webp" width="250" alt="Made with ChatGPT">
</p>

<p align="center">
    Fig. 1 - This is the caption. What a nice picture!
</p>

---

**And there you have it! üèÜ**

A whimsical tour through Markdown, LaTeX, and HTML. May your documents be ever stylish and your equations ever solvable!

[1]: https://en.wikipedia.org/wiki/Markdown "Markdown"  
[2]: https://en.wikipedia.org/wiki/LaTeX "LaTeX"
  `;

  /**
   * Preprocess the input Markdown by replacing all single backslashes with double backslashes
   * within LaTeX math blocks. This ensures that LaTeX commands requiring backslashes are
   * correctly interpreted by MathJax without affecting other parts of the Markdown content.
   * 
   * @param {string} input - The raw Markdown input from the user.
   * @returns {string} - The processed Markdown with escaped backslashes in LaTeX blocks.
   */
  function preprocessMarkdown(input) {
    // Regex to match inline ($...$) and display ($$...$$) math blocks
    const regex = /(\$\$?)([\s\S]+?)\1/g;
    return input.replace(regex, function(match, p1, p2) {
      // Replace single backslashes with double backslashes within LaTeX blocks
      const escaped = p2.replace(/\\/g, '\\\\');
      return p1 + escaped + p1;
    });
  }

  function renderContent() {
    const inputText = markdownInput.value;
    const preprocessedText = preprocessMarkdown(inputText);
    const parsedMarkdown = marked.parse(preprocessedText);
    const sanitizedContent = DOMPurify.sanitize(parsedMarkdown);
    renderedOutput.innerHTML = sanitizedContent;
    MathJax.typesetPromise([renderedOutput]).catch(console.error);
  }

  async function printToPDF() {
    await MathJax.typesetPromise([renderedOutput]);
    window.print();
  }

  function exportHTML() {
    const fileName = prompt('Enter file name for the HTML export:', 'document.html');
    if (!fileName) return;

    const sanitizedHTML = renderedOutput.innerHTML;
    const doc = document.implementation.createHTMLDocument('Exported Document');
    const head = doc.head;
    const body = doc.body;

    const style = document.createElement('style');
    style.textContent = `
      body {
        font-family: Helvetica, sans-serif;
        line-height: 1.6;
        margin: 20px;
        background-color: #ffffff;
        color: #000000;
      }
      table {
        max-width: 90%;
        margin: 20px auto;
        border-collapse: collapse;
        border: 1px solid black;
      }
      th, td {
        border: 1px solid black;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f4f4f4;
      }
      code {
        background-color: #f0f0f0;
        padding: 0.1em 0.2em;
        border-radius: 3px;
        font-size: 0.95em;
        line-height: 1;
        font-family: "Courier New", Courier, monospace;
        vertical-align: baseline;
      }
    `;
    head.appendChild(style);

    // Add MathJax configuration
    const mathjaxConfigScript = document.createElement('script');
    mathjaxConfigScript.textContent = `
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$']],
          displayMath: [['$$', '$$']],
          processEscapes: true, // Keeping as true
          packages: ['base', 'ams'],
        },
        svg: {
          fontCache: 'local',
        }
      };
    `;
    head.appendChild(mathjaxConfigScript);

    const mathjaxScript = document.createElement('script');
    mathjaxScript.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js';
    head.appendChild(mathjaxScript);

    body.innerHTML = sanitizedHTML;

    const exportedHTML = `<!DOCTYPE html>${doc.documentElement.outerHTML}`;
    const blob = new Blob([exportedHTML], { type: 'text/html' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = fileName;
    link.click();
  }

  function saveMarkdown() {
    const fileName = prompt('Enter file name for the Markdown file:', 'document.md');
    if (!fileName) return;

    const blob = new Blob([markdownInput.value], { type: 'text/markdown' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = fileName;
    link.click();
  }

  function loadMarkdownFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.md,text/markdown';
    input.onchange = e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = event => {
          markdownInput.value = event.target.result;
          renderContent();
        };
        reader.readAsText(file);
      }
    };
    input.click();
  }

  function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    if (document.body.classList.contains('dark-mode')) {
      themeToggleButton.textContent = 'üåô';
      themeToggleButton.setAttribute('aria-label', 'Switch to Light Mode');
      themeToggleButton.setAttribute('title', 'Switch to Light Mode');
    } else {
      themeToggleButton.textContent = '‚òÄÔ∏è';
      themeToggleButton.setAttribute('aria-label', 'Switch to Dark Mode');
      themeToggleButton.setAttribute('title', 'Switch to Dark Mode');
    }
  }

  // Event Listeners
  markdownInput.addEventListener('input', renderContent);
  printButton.addEventListener('click', printToPDF);
  exportHTMLButton.addEventListener('click', exportHTML);
  saveMDButton.addEventListener('click', saveMarkdown);
  loadFileButton.addEventListener('click', loadMarkdownFile);
  loadSampleButton.addEventListener('click', () => {
    markdownInput.value = sampleDocument;
    renderContent();
  });
  clearButton.addEventListener('click', () => {
    markdownInput.value = '';
    renderContent();
  });
  themeToggleButton.addEventListener('click', toggleTheme);

  // Initial render
  renderContent();
  </script>
</body>
</html>
