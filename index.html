<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <link rel="manifest" href="/manifest.json">
    <script src="/assets/sw-register.js" defer></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>PanPhy Labs | Physics Tools & Simulations</title>
    <meta name="description"
        content="PanPhy Labs is a portfolio of physics tools, simulations, and interactive mini apps.">
    <meta property="og:title" content="PanPhy Labs">
    <meta property="og:description"
        content="PanPhy Labs is a portfolio of physics tools, simulations, and interactive mini apps.">
    <meta name="twitter:title" content="PanPhy Labs">
    <meta name="twitter:description"
        content="PanPhy Labs is a portfolio of physics tools, simulations, and interactive mini apps.">

    <link rel="icon" type="image/png" href="/assets/favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&family=Poppins:wght@600;700;800&display=swap');

        /* CSS Variables */
        :root {
            --font-sans: 'Inter', sans-serif;
            --font-display: 'Poppins', 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;

            /* Light Theme */
            --bg-color: #f8f9fa;
            --bg-pattern: #e9ecef;
            --text-main: #2d3436;
            --text-secondary: #636e72;

            --brand-primary: #6c5ce7;
            /* Indigo */
            --brand-secondary: #a29bfe;
            --brand-accent: #00cec9;
            /* Teal */

            --nav-bg: rgba(255, 255, 255, 0.85);
            --nav-border: rgba(255, 255, 255, 0.5);

            --card-bg: #ffffff;
            --card-border: transparent;
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            --card-hover-shadow: 0 20px 40px rgba(108, 92, 231, 0.15);

            --btn-bg: #2d3436;
            --btn-text: #fff;

            --status-check: #2563eb;
            --status-ready: #0f9d58;
            --status-warning: #d97706;
            --status-error: #dc2626;
        }

        [data-theme="dark"] {
            /* Dark Theme */
            --bg-color: #0f1014;
            --bg-pattern: #181a20;
            --text-main: #dfe6e9;
            --text-secondary: #b2bec3;

            --brand-primary: #a29bfe;
            --brand-secondary: #6c5ce7;
            --brand-accent: #81ecec;

            --nav-bg: rgba(22, 24, 29, 0.85);
            --nav-border: rgba(255, 255, 255, 0.05);

            --card-bg: #1e2129;
            --card-border: #2d3436;
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            --card-hover-shadow: 0 20px 40px rgba(108, 92, 231, 0.2);

            --btn-bg: #6c5ce7;
            --btn-text: #fff;

            --status-check: #7da8ff;
            --status-ready: #4cd08d;
            --status-warning: #f6b354;
            --status-error: #ff7d7d;
        }

        * {
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, transform 0.2s ease;
        }

        .offline-font {
            --font-sans: 'Inter', 'Poppins', sans-serif;
            --font-display: 'Poppins', 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        body {
            font-family: var(--font-sans);
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Hero Header */
        header {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 6rem 1.5rem 4rem;
            text-align: center;
            position: relative;
        }

        .logo {
            height: 80px;
            width: auto;
            margin-bottom: 1.5rem;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
        }

        header h1 {
            font-family: var(--font-display);
            font-size: 3.5rem;
            font-weight: 800;
            margin: 0;
            letter-spacing: -1px;
            color: var(--brand-primary);
        }

        header h1.gradient-text {
            background: linear-gradient(135deg, var(--brand-primary), var(--brand-accent));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        header p {
            font-size: 1.25rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin-top: 1rem;
        }

        @keyframes offlinePulse {
            0% {
                box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.45);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(37, 99, 235, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);
            }
        }

        /* Floating Navigation */
        nav {
            position: fixed;
            top: calc(12px + env(safe-area-inset-top, 0px));
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            background: var(--nav-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 0.5rem 0.5rem;
            border-radius: 50px;
            border: 1px solid var(--nav-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: max-content;
            max-width: 90%;
        }

        nav a {
            color: var(--text-main);
            text-decoration: none;
            margin: 0 0.5rem;
            padding: 0.5rem 1.2rem;
            font-size: 0.95rem;
            font-weight: 600;
            border-radius: 25px;
            transition: all 0.3s ease;
        }

        nav a:hover {
            background-color: var(--brand-primary);
            color: #fff;
        }

        nav a,
        .card a,
        .theme-toggle button {
            touch-action: manipulation;
        }

        /* Theme Toggle Inside Nav */
        .theme-toggle button {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 0.5rem;
        }

        .theme-toggle button:hover {
            background-color: rgba(128, 128, 128, 0.2);
            transform: rotate(15deg);
        }

        /* Sections */
        .section {
            max-width: 1200px;
            margin: 0 auto 5rem;
            padding: 0 1.5rem;
            scroll-margin-top: 80px;
        }

        .section h2 {
            font-family: var(--font-display);
            font-size: 2rem;
            margin-bottom: 2rem;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section h2::before {
            content: '';
            display: block;
            width: 8px;
            height: 32px;
            background: linear-gradient(to bottom, var(--brand-primary), var(--brand-accent));
            border-radius: 4px;
        }

        /* Grid & Cards */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
            height: 100%;
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: var(--card-hover-shadow);
            border-color: var(--brand-primary);
        }

        /* Modern Card Decoration ‚Äî soft fade into card */
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5%;
            background: linear-gradient(90deg, var(--brand-primary), var(--brand-accent));
            -webkit-mask-image: linear-gradient(to bottom, rgba(0,0,0,0.4), transparent);
            mask-image: linear-gradient(to bottom, rgba(0,0,0,0.4), transparent);
            opacity: 0;
            transition: opacity 0.3s;
            border-radius: 20px 20px 0 0;
        }

        .card:hover::before {
            opacity: 1;
        }

        .card h3 {
            font-family: var(--font-display);
            font-size: 1.4rem;
            margin: 0 0 0.8rem 0;
            color: var(--text-main);
        }

        .card p {
            font-size: 1rem;
            margin: 0 0 1.5rem 0;
            color: var(--text-secondary);
            flex-grow: 1;
        }

        .card-offline-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.28rem;
            position: absolute;
            top: 0.85rem;
            right: 0.85rem;
            z-index: 2;
            padding: 0.26rem 0.45rem;
            border-radius: 999px;
            border: 1px solid var(--nav-border);
            background: var(--nav-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            color: var(--text-secondary);
            font-size: 10px;
            line-height: 1.1;
            font-weight: 600;
            white-space: nowrap;
        }

        .card-offline-pill::before {
            content: '';
            width: 0.36rem;
            height: 0.36rem;
            border-radius: 50%;
            background: var(--status-check);
            box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.45);
        }

        .card-offline-pill[data-state="checking"]::before {
            background: var(--status-check);
            animation: offlinePulse 1.4s ease-out infinite;
        }

        .card-offline-pill[data-state="ready"]::before {
            background: var(--status-ready);
            animation: none;
            box-shadow: none;
        }

        .card-offline-pill[data-state="warning"]::before {
            background: var(--status-warning);
            animation: none;
            box-shadow: none;
        }

        .card-offline-pill[data-state="ready"] {
            color: var(--status-ready);
        }

        .card-offline-pill[data-state="warning"] {
            color: var(--status-warning);
        }

        .card a {
            display: inline-block;
            text-align: center;
            background: transparent;
            color: var(--brand-primary);
            text-decoration: none;
            padding: 0.8rem 1.5rem;
            font-weight: 600;
            border-radius: 12px;
            border: 2px solid var(--brand-primary);
            transition: all 0.3s ease;
            align-self: flex-start;
        }

        .card a:hover {
            background: var(--brand-primary);
            color: #fff;
            transform: translateY(-2px);
        }

        /* About Section Enhancement */
        #about p {
            font-size: 1.1rem;
            max-width: 800px;
            color: var(--text-secondary);
        }

        /* Footer */
        footer {
            background: var(--card-bg);
            color: var(--text-secondary);
            text-align: center;
            padding: 1.25rem 1.5rem;
            margin-top: 4rem;
            border-top: 1px solid var(--card-border);
        }

        footer p {
            margin-bottom: 0.5rem;
        }

        footer a {
            color: var(--brand-primary);
            text-decoration: none;
            font-weight: 600;
        }

        footer a:hover {
            text-decoration: underline;
        }

        /* Responsive Tweaks */
        @media (max-width: 768px) {
            header h1 {
                font-size: 2.5rem;
            }

            nav {
                width: calc(100vw - 16px);
                max-width: 760px;
                display: grid;
                grid-template-columns: repeat(5, minmax(0, 1fr)) auto;
                align-items: center;
                gap: 0.15rem;
                padding: 0.35rem 0.4rem;
                overflow: hidden;
                white-space: nowrap;
            }

            nav a {
                margin: 0;
                padding: 0.4rem 0.3rem;
                font-size: 0.78rem;
                text-align: center;
            }

            .theme-toggle {
                display: flex;
                justify-content: center;
            }

            .theme-toggle button {
                margin-left: 0;
                padding: 0.35rem;
            }

            .grid {
                grid-template-columns: 1fr;
            }
        }

        @media (pointer: coarse) {

            nav a,
            .card a,
            .theme-toggle button {
                min-height: 44px;
            }
        }

        /* Spacetime Grid Background */
        .spacetime-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .spacetime-bg canvas {
            width: 100%;
            height: 100%;
        }

        @media (prefers-reduced-motion: reduce) {
            .spacetime-bg { display: none; }
        }

        /* Ensure content sits above the background */
        header, .section, footer {
            position: relative;
            z-index: 1;
        }

        nav {
            z-index: 1000;
        }
    </style>
</head>

<body>
    <div class="spacetime-bg" aria-hidden="true">
        <canvas id="spacetime-canvas"></canvas>
    </div>

    <nav>
        <a href="#tools">Tools</a>
        <a href="#simulations">Sims</a>
        <a href="#for_teachers">Teachers</a>
        <a href="#fun">Fun</a>
        <a href="#about">About</a>
        <div class="theme-toggle">
            <button id="theme-button" aria-label="Toggle Light/Dark Theme">‚òÄÔ∏è</button>
        </div>
    </nav>

    <header>
        <img src="/assets/panphy.png" alt="PanPhy Logo" class="logo" onerror="this.style.display='none'">
        <h1>PanPhy Labs</h1>
        <p>Physics apps, tools, sims, and some random stuff.</p>
    </header>

    <div class="section" id="tools">
        <h2>Tools</h2>
        <div class="grid">
            <div class="card">
                <h3>Markdown + LaTeX</h3>
                <p>Write, preview, and present scientific documents with LaTeX support.</p>
                <a href="/tools/markdown_editor.html">Open Editor</a>
            </div>
            <div class="card">
                <h3>Data Plotting & Fitting</h3>
                <p>Process data, plot graphs, add uncertainties, and run best-fit analysis.</p>
                <a href="/tools/panphyplot.html">Plot Data</a>
            </div>
            <div class="card">
                <h3>Motion Tracker</h3>
                <p>Step through video frames, click to track objects, and extract motion data.</p>
                <a href="/tools/motion_tracker.html">Track Motion</a>
            </div>
            <div class="card">
                <h3>Sound Analyzer</h3>
                <p>Visualize live audio as a frequency spectrum and waveform.</p>
                <a href="/tools/sound_analyzer.html">Analyze Sound</a>
            </div>
            <div class="card">
                <h3>Tone Generator</h3>
                <p>Play and combine multiple sine waves with real-time waveform display.</p>
                <a href="/tools/tone_generator.html">Generate Tone</a>
            </div>
        </div>
    </div>

    <div class="section" id="simulations">
        <h2>Simulations</h2>
        <div class="grid">
            <div class="card">
                <h3>Wave Superposition</h3>
                <p>Learn how waves interact.</p>
                <a href="/simulations/superposition.html">Launch Sim</a>
            </div>
            <div class="card">
                <h3>Standing Wave</h3>
                <p>Visualize standing waves with different boundary conditions.</p>
                <a href="/simulations/standing_wave.html">Launch Sim</a>
            </div>
            <div class="card">
                <h3>Lorentz Transform</h3>
                <p>Learn how spacetime transforms between inertial frames.</p>
                <a href="/simulations/lorentz.html">Launch Sim</a>
            </div>
            <div class="card">
                <h3>Collision Lab</h3>
                <p>Experiment with collision physics using interactive, real-time motion.</p>
                <a href="/simulations/collision.html">Launch Sim</a>
            </div>
        </div>
    </div>

    <div class="section" id="for_teachers">
        <h2>For Teachers</h2>
        <div class="grid">
            <div class="card">
                <h3>Exam Timer</h3>
                <p>Manage exam times with an automatic extra-time timer.</p>
                <a href="/for_teachers/timer.html">Open Timer</a>
            </div>
            <div class="card">
                <h3>Camera Visualizer</h3>
                <p>Project your device camera to the big screen, then snap & sketch.</p>
                <a href="/for_teachers/visualizer.html">Use Camera</a>
            </div>
            <div class="card">
                <h3>EAL Companion</h3>
                <p>AI-powered language support for EAL learners.</p>
                <a href="https://panphy-eal.streamlit.app/" target="_blank" rel="noopener noreferrer">Open App</a>
            </div>
        </div>
    </div>

    <div class="section" id="fun">
        <h2>For Fun</h2>
        <div class="grid">
            <div class="card">
                <h3>Asteroid Storm</h3>
                <p>Survive the asteroid storm! Beat top survivors worldwide!</p>
                <a href="/fun/dodge.html">Play Now</a>
            </div>
            <div class="card">
                <h3>Hit Me!</h3>
                <p>Wait for it... tap when green! Tracks your best and average times.</p>
                <a href="/fun/react.html">Play Now</a>
            </div>
            <div class="card">
                <h3>ASCII Camera</h3>
                <p>See yourself in 8-bit color ASCII characters.</p>
                <a href="/fun/ascii_cam.html">Open Camera</a>
            </div>
        </div>
    </div>

    <div class="section" id="about">
        <h2>About</h2>
        <p>
            Welcome to <strong>PanPhy Labs</strong>. The tools, simulations, and games here are built with AI and
            designed to be interactive and educational. While there are many great web tools and physics simulations
            online, not all meet my needs. On school-managed devices, students and teachers often don't have the
            admin rights to install software, so I build my own web apps: simple, browser-based, and ready for
            everyone to explore and enjoy.
            <br><br>
            Most apps are also offline-friendly. After your first visit, the site caches each app in the
            background &mdash; look for the <strong>Offline ready</strong> badge on each card above. Once cached,
            those tools, simulations, and games work without an internet connection. A few features that rely on
            external services (Asteroid Storm's leaderboard and the EAL Companion) still require internet access.
        </p>
    </div>

    <footer>
        <p>&copy; 2026 PanPhy Labs</p>
        <p>
            <a href="mailto:panphylabs@icloud.com">Contact Me</a> ‚Ä¢
            <a href="https://buymeacoffee.com/panphy" target="_blank" rel="noopener noreferrer">Support My Projects</a>
        </p>
    </footer>

    <script>
        // Spacetime Grid Warp Animation
        (function () {
            var canvas = document.getElementById('spacetime-canvas');
            if (!canvas) return;
            var ctx = canvas.getContext('2d');
            var dpr = window.devicePixelRatio || 1;
            var w, h, cols, rows;
            var spacing = 40;
            var time = 0;

            // Mouse-driven mass
            var mouseX = 0;
            var mouseY = 0;
            var activeX = 0;
            var activeY = 0;
            var strength = 120;
            var massRadius = 180;
            var hasPointerInteraction = false;

            // Idle detection & 30fps throttle
            var running = false;
            var lastFrameTime = 0;
            var frameInterval = 1000 / 60; // 60fps
            var idleThreshold = 0.5; // stop when active is within 0.5px of mouse

            function wake() {
                if (!running) {
                    running = true;
                    lastFrameTime = performance.now();
                    requestAnimationFrame(loop);
                }
            }

            function clamp(value, min, max) {
                return Math.max(min, Math.min(max, value));
            }

            function getInitialAnchor() {
                var heading = document.querySelector('header h1');
                if (!heading) {
                    return {
                        x: w * 0.66,
                        y: h * 0.28
                    };
                }

                var rect = heading.getBoundingClientRect();
                return {
                    x: clamp(rect.right + Math.max(48, rect.width * 0.18), 80, w - 80),
                    y: clamp(rect.top + rect.height * 0.58, 80, h - 80)
                };
            }

            function setPointerTarget(x, y, snapActive) {
                mouseX = x;
                mouseY = y;
                if (snapActive) {
                    activeX = x;
                    activeY = y;
                }
                wake();
            }

            function handlePointerInput(x, y) {
                if (!hasPointerInteraction) {
                    hasPointerInteraction = true;
                    // Avoid a long startup chase from the landing anchor.
                    setPointerTarget(x, y, true);
                    return;
                }
                setPointerTarget(x, y, false);
            }

            document.addEventListener('mousemove', function (e) {
                handlePointerInput(e.clientX, e.clientY);
            });
            document.addEventListener('touchmove', function (e) {
                handlePointerInput(e.touches[0].clientX, e.touches[0].clientY);
            }, { passive: true });
            document.addEventListener('touchstart', function (e) {
                handlePointerInput(e.touches[0].clientX, e.touches[0].clientY);
            }, { passive: true });

            function resize() {
                w = window.innerWidth;
                h = window.innerHeight;
                canvas.width = w * dpr;
                canvas.height = h * dpr;
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
                cols = Math.ceil(w / spacing) + 2;
                rows = Math.ceil(h / spacing) + 2;
                if (!hasPointerInteraction) {
                    var anchor = getInitialAnchor();
                    mouseX = anchor.x;
                    mouseY = anchor.y;
                    activeX = anchor.x;
                    activeY = anchor.y;
                }
                wake();
            }

            function getGridColor() {
                var theme = document.documentElement.getAttribute('data-theme');
                return theme === 'dark'
                    ? 'rgba(162, 155, 254, 0.12)'
                    : 'rgba(108, 92, 231, 0.10)';
            }

            function getNodeColor() {
                var theme = document.documentElement.getAttribute('data-theme');
                return theme === 'dark'
                    ? 'rgba(162, 155, 254, 0.25)'
                    : 'rgba(108, 92, 231, 0.18)';
            }

            function warp(gx, gy, t) {
                var distX = gx - activeX;
                var distY = gy - activeY;
                var dist = Math.sqrt(distX * distX + distY * distY);
                if (dist < 1) dist = 1;
                var falloff = Math.exp(-(dist * dist) / (massRadius * massRadius));
                var ripple = Math.sin(dist * 0.04 - t * 1.5) * 0.3;
                var pull = (strength * falloff * (1 + ripple)) / (dist + 50);
                return {
                    x: gx - distX * pull,
                    y: gy - distY * pull
                };
            }

            function draw() {
                time += 0.008;
                ctx.clearRect(0, 0, w, h);

                // Slowly chase the cursor (lower = more sluggish)
                activeX += (mouseX - activeX) * 0.02;
                activeY += (mouseY - activeY) * 0.02;

                var lineColor = getGridColor();
                var nodeColor = getNodeColor();

                // Compute warped grid positions
                var grid = [];
                for (var r = 0; r <= rows; r++) {
                    grid[r] = [];
                    for (var c = 0; c <= cols; c++) {
                        var gx = c * spacing;
                        var gy = r * spacing;
                        grid[r][c] = warp(gx, gy, time);
                    }
                }

                // Draw grid lines
                ctx.strokeStyle = lineColor;
                ctx.lineWidth = 0.8;
                ctx.beginPath();

                // Horizontal lines
                for (var r = 0; r <= rows; r++) {
                    var p = grid[r][0];
                    ctx.moveTo(p.x, p.y);
                    for (var c = 1; c <= cols; c++) {
                        p = grid[r][c];
                        ctx.lineTo(p.x, p.y);
                    }
                }

                // Vertical lines
                for (var c = 0; c <= cols; c++) {
                    var p = grid[0][c];
                    ctx.moveTo(p.x, p.y);
                    for (var r = 1; r <= rows; r++) {
                        p = grid[r][c];
                        ctx.lineTo(p.x, p.y);
                    }
                }

                ctx.stroke();

                // Draw subtle nodes at intersections near warp centers
                ctx.fillStyle = nodeColor;
                for (var r = 0; r <= rows; r++) {
                    for (var c = 0; c <= cols; c++) {
                        var p = grid[r][c];
                        var origX = c * spacing;
                        var origY = r * spacing;
                        var distortion = Math.sqrt(
                            (p.x - origX) * (p.x - origX) +
                            (p.y - origY) * (p.y - origY)
                        );
                        if (distortion > 2) {
                            var radius = Math.min(2.5, 0.8 + distortion * 0.08);
                            ctx.beginPath();
                            ctx.arc(p.x, p.y, radius, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }
                }
            }

            function loop(now) {
                if (!running) return;

                // Throttle to 30fps
                if (now - lastFrameTime < frameInterval) {
                    requestAnimationFrame(loop);
                    return;
                }
                lastFrameTime = now;

                draw();

                // Go idle when the warp has caught up to the cursor
                var dx = mouseX - activeX;
                var dy = mouseY - activeY;
                if (dx * dx + dy * dy < idleThreshold * idleThreshold) {
                    // One final draw at rest, then stop
                    draw();
                    running = false;
                    return;
                }

                requestAnimationFrame(loop);
            }

            resize();
            window.addEventListener('resize', resize);
            // Respect prefers-reduced-motion
            var mq = window.matchMedia('(prefers-reduced-motion: reduce)');
            if (!mq.matches) {
                // Draw once immediately at the landing anchor.
                draw();
            }
        })();
    </script>
    <script>
        // Theme Toggle Functionality
        const themeButton = document.getElementById('theme-button');
        const DARK_THEME_KEY = "panphy-dark";
        const LIGHT_THEME_KEY = "panphy-light";

        const currentTheme = localStorage.getItem(DARK_THEME_KEY) ?
            "dark" :
            localStorage.getItem(LIGHT_THEME_KEY) ?
                "light" :
                "light";

        document.documentElement.setAttribute('data-theme', currentTheme);
        updateButtonEmoji(currentTheme);

        function updateButtonEmoji(theme) {
            themeButton.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        }

        themeButton.addEventListener('click', function () {
            let theme = document.documentElement.getAttribute('data-theme');
            if (theme === 'light') {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem(DARK_THEME_KEY, 'true');
                localStorage.removeItem(LIGHT_THEME_KEY);
                updateButtonEmoji('dark');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem(LIGHT_THEME_KEY, 'true');
                localStorage.removeItem(DARK_THEME_KEY);
                updateButtonEmoji('light');
            }
        });

        const OFFLINE_CARD_REQUIREMENTS = {
            '/tools/markdown_editor.html': [
                '/tools/markdown_editor.html',
                '/tools/markdown_editor/css/markdown_editor.css',
                '/tools/markdown_editor/js/main.js',
                'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js',
                'https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js',
                'https://cdn.jsdelivr.net/npm/dompurify@2.3.4/dist/purify.min.js',
                'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js'
            ],
            '/tools/panphyplot.html': [
                '/tools/panphyplot.html',
                '/tools/panphyplot/js/main.js',
                '/tools/panphyplot/js/fit-worker.js',
                'https://cdn.plot.ly/plotly-basic-2.29.1.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.5.0/math.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_SVG.js'
            ],
            '/tools/motion_tracker.html': [
                '/tools/motion_tracker.html',
                'https://cdn.jsdelivr.net/npm/chart.js'
            ],
            '/tools/sound_analyzer.html': ['/tools/sound_analyzer.html'],
            '/tools/tone_generator.html': ['/tools/tone_generator.html'],
            '/simulations/superposition.html': ['/simulations/superposition.html'],
            '/simulations/standing_wave.html': ['/simulations/standing_wave.html'],
            '/simulations/lorentz.html': ['/simulations/lorentz.html'],
            '/simulations/collision.html': [
                '/simulations/collision.html',
                '/simulations/collision/app.js',
                'https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js',
                '/simulations/collision/collision_assets/models/hand_landmarker.task',
                '/simulations/collision/collision_assets/mediapipe/tasks-vision-0.10.32/vision_bundle.mjs',
                '/simulations/collision/collision_assets/mediapipe/tasks-vision-0.10.32/wasm/vision_wasm_internal.js',
                '/simulations/collision/collision_assets/mediapipe/tasks-vision-0.10.32/wasm/vision_wasm_internal.wasm',
                '/simulations/collision/collision_assets/mediapipe/tasks-vision-0.10.32/wasm/vision_wasm_nosimd_internal.js',
                '/simulations/collision/collision_assets/mediapipe/tasks-vision-0.10.32/wasm/vision_wasm_nosimd_internal.wasm'
            ],
            '/for_teachers/timer.html': [
                '/for_teachers/timer.html',
                '/for_teachers/timer_beep.mp3'
            ],
            '/for_teachers/visualizer.html': ['/for_teachers/visualizer.html'],
            '/fun/react.html': ['/fun/react.html'],
            '/fun/ascii_cam.html': ['/fun/ascii_cam.html']
        };
        const OFFLINE_APP_PATHS = Object.keys(OFFLINE_CARD_REQUIREMENTS);
        const OFFLINE_REQUIRED_ASSETS = [...new Set(
            OFFLINE_APP_PATHS.flatMap((path) => OFFLINE_CARD_REQUIREMENTS[path])
        )];
        const offlineCardPills = new Map();

        let offlineReadyPollId = 0;
        let offlineReadinessUpdateInFlight = false;

        function setCardOfflineState(pill, state, label) {
            if (!pill) return;
            pill.dataset.state = state;
            pill.textContent = label;
        }

        function normalizeCardPath(hrefValue) {
            try {
                const url = new URL(hrefValue, window.location.origin);
                if (url.origin !== window.location.origin) return null;
                return url.pathname;
            } catch (error) {
                return null;
            }
        }

        function initOfflineCardPills() {
            const cardLinks = document.querySelectorAll('.card a[href]');
            cardLinks.forEach((link) => {
                const cardPath = normalizeCardPath(link.getAttribute('href'));
                if (!cardPath || !OFFLINE_CARD_REQUIREMENTS[cardPath]) return;

                const card = link.closest('.card');
                if (!card || offlineCardPills.has(cardPath)) return;

                const pill = document.createElement('span');
                pill.className = 'card-offline-pill';
                setCardOfflineState(pill, 'checking', 'Caching...');
                card.prepend(pill);
                offlineCardPills.set(cardPath, pill);
            });
        }

        async function getAssetCacheMap(assets) {
            const cacheMap = new Map();
            if (!('caches' in window)) {
                return cacheMap;
            }

            const checks = await Promise.all(
                assets.map(async (asset) => {
                    try {
                        const absoluteUrl = new URL(asset, window.location.origin).href;
                        // CDN assets often send Vary headers; ignore them for readiness checks.
                        const match = await caches.match(absoluteUrl, { ignoreVary: true });
                        return [asset, Boolean(match)];
                    } catch (error) {
                        return [asset, false];
                    }
                })
            );

            checks.forEach(([asset, isCached]) => {
                cacheMap.set(asset, isCached);
            });
            return cacheMap;
        }

        function updateOfflineCardPills(cacheMap) {
            let readyApps = 0;

            OFFLINE_APP_PATHS.forEach((path) => {
                const requirements = OFFLINE_CARD_REQUIREMENTS[path];
                const ready = requirements.every((asset) => cacheMap.get(asset));
                if (ready) {
                    readyApps += 1;
                }

                const pill = offlineCardPills.get(path);
                if (!pill) return;

                if (ready) {
                    setCardOfflineState(pill, 'ready', 'Offline ready');
                    return;
                }
                if (!navigator.onLine) {
                    setCardOfflineState(pill, 'warning', 'Needs internet');
                    return;
                }
                setCardOfflineState(pill, 'checking', 'Caching...');
            });

            return {
                readyApps,
                totalApps: OFFLINE_APP_PATHS.length
            };
        }

        async function updateOfflineReadiness() {
            if (offlineReadinessUpdateInFlight) return;
            offlineReadinessUpdateInFlight = true;

            try {
                if (!('serviceWorker' in navigator) || !('caches' in window)) {
                    offlineCardPills.forEach((pill) => {
                        setCardOfflineState(pill, 'warning', 'Needs internet');
                    });
                    if (offlineReadyPollId) {
                        clearInterval(offlineReadyPollId);
                        offlineReadyPollId = 0;
                    }
                    return;
                }

                const cacheMap = await getAssetCacheMap(OFFLINE_REQUIRED_ASSETS);
                const summary = updateOfflineCardPills(cacheMap);

                if (summary.readyApps === summary.totalApps) {
                    if (offlineReadyPollId) {
                        clearInterval(offlineReadyPollId);
                        offlineReadyPollId = 0;
                    }
                    return;
                }

                if (!navigator.onLine) {
                    return;
                }

            } catch (error) {
                offlineCardPills.forEach((pill) => {
                    if (pill.dataset.state !== 'ready') {
                        setCardOfflineState(pill, 'warning', 'Needs internet');
                    }
                });
            } finally {
                offlineReadinessUpdateInFlight = false;
            }
        }

        function startOfflineReadinessMonitor() {
            initOfflineCardPills();
            updateOfflineReadiness();
            if (!offlineReadyPollId) {
                offlineReadyPollId = setInterval(updateOfflineReadiness, 3000);
            }
            window.addEventListener('online', updateOfflineReadiness);
            window.addEventListener('offline', updateOfflineReadiness);
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    updateOfflineReadiness();
                }
            });
        }

        startOfflineReadinessMonitor();
    </script>
    <script>
        // Apply gradient text effect, skip on Brave iOS where background-clip:text is broken
        (function () {
            var h1 = document.querySelector('header h1');
            if (!h1) return;
            var isIOS = /iP(hone|ad|od)/.test(navigator.userAgent);
            var isBrave = !!navigator.brave;
            if (!(isIOS && isBrave)) {
                h1.classList.add('gradient-text');
            }
        })();
    </script>
    <script>
        function updateOfflineFontState() {
            document.documentElement.classList.toggle('offline-font', !navigator.onLine);
        }

        window.addEventListener('online', updateOfflineFontState);
        window.addEventListener('offline', updateOfflineFontState);
        updateOfflineFontState();
    </script>

</body>

</html>
