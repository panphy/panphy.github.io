<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multi-Channel Tone Generator</title>
  <link rel="icon" type="image/png" href="/assets/favicon.png">
    <script src="/assets/sw-register.js" defer></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&family=Poppins:wght@600;700;800&display=swap');

    :root {
      --font-sans: 'Inter', sans-serif;
      --font-display: 'Poppins', 'Inter', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;

      --bg-color: #f8f9fa;
      --bg-pattern: #e9ecef;
      --text-main: #2d3436;
      --text-secondary: #636e72;

      --brand-primary: #6c5ce7;
      --brand-secondary: #a29bfe;
      --brand-accent: #00cec9;

      --nav-bg: rgba(255, 255, 255, 0.85);
      --nav-border: rgba(255, 255, 255, 0.5);

      --card-bg: #ffffff;
      --card-border: transparent;
      --card-shadow: 0 16px 40px rgba(0, 0, 0, 0.08);
      --card-shadow-soft: 0 8px 24px rgba(0, 0, 0, 0.06);
      --image-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      --pill-shadow-hover: 0 12px 24px rgba(0, 0, 0, 0.12);
      --thumb-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);

      --surface-strong: #f1f3f5;
      --surface-muted: #e9ecef;

      --border: rgba(45, 52, 54, 0.15);
      --btn-bg-color: #2d3436;
      --btn-bg-hover: #1b1f21;
      --btn-text-color: #ffffff;
      --btn-border-color: transparent;

      --slider-bg: #dfe6e9;
      --slider-bg-hover: #cfd8dc;
      --slider-thumb: #6c5ce7;
      --focus-ring: rgba(108, 92, 231, 0.25);

      --wave-bg: #f1f3f5;
      --wave-channel: #2d98da;
      --wave-combined: #e84393;
    }

    [data-theme="dark"] {
      --bg-color: #0f1014;
      --bg-pattern: #181a20;
      --text-main: #dfe6e9;
      --text-secondary: #b2bec3;

      --brand-primary: #a29bfe;
      --brand-secondary: #6c5ce7;
      --brand-accent: #81ecec;

      --nav-bg: rgba(22, 24, 29, 0.85);
      --nav-border: rgba(255, 255, 255, 0.05);

      --card-bg: #1e2129;
      --card-border: #2d3436;
      --card-shadow: 0 16px 40px rgba(0, 0, 0, 0.3);
      --card-shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.25);
      --image-shadow: 0 4px 8px rgba(0, 0, 0, 0.35);
      --pill-shadow-hover: 0 12px 24px rgba(0, 0, 0, 0.35);
      --thumb-shadow: 0 1px 3px rgba(0, 0, 0, 0.45);

      --surface-strong: #111318;
      --surface-muted: #17191f;

      --border: #2d3436;
      --btn-bg-color: #6c5ce7;
      --btn-bg-hover: #5b4ad8;
      --btn-text-color: #ffffff;
      --btn-border-color: transparent;

      --slider-bg: #3a3f4b;
      --slider-bg-hover: #4a4f5b;
      --slider-thumb: #a29bfe;
      --focus-ring: rgba(162, 155, 254, 0.3);

      --wave-bg: #111318;
      --wave-channel: #57c7ff;
      --wave-combined: #ff638f;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    * {
      box-sizing: border-box;
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, transform 0.2s ease;
    }

    body {
      background-color: var(--bg-color);
      background-image: radial-gradient(var(--bg-pattern) 1px, transparent 1px);
      background-size: 30px 30px;
      color: var(--text-main);
      font-family: var(--font-sans);
      display: flex;
      flex-direction: column;
    }

    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1.5rem;
      background: var(--nav-bg);
      margin: 1rem auto 0.75rem;
      padding: 0.75rem 1.5rem;
      border-radius: 20px;
      border: 1px solid var(--nav-border);
      box-shadow: var(--card-shadow);
      max-width: 1200px;
      width: calc(100% - 3rem);
      backdrop-filter: blur(12px);
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .header-brand img {
      max-height: 38px;
      width: auto;
      height: auto;
      filter: drop-shadow(var(--image-shadow));
    }

    .header-title {
      margin: 0;
      font-size: 1.6rem;
      font-weight: 700;
      letter-spacing: -0.5px;
      font-family: var(--font-display);
      color: var(--brand-primary);
    }

    .header-title.gradient-text {
      background: linear-gradient(135deg, var(--brand-primary), var(--brand-accent));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .header-subtitle {
      margin: 0.2rem 0 0;
      font-size: 0.95rem;
      color: var(--text-secondary);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .pill-link {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.45rem 1rem;
      border-radius: 999px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      color: var(--text-main);
      font-weight: 600;
      font-size: 0.9rem;
      box-shadow: var(--card-shadow-soft);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .pill-link:hover {
      transform: translateY(-1px);
      text-decoration: none;
      box-shadow: var(--pill-shadow-hover);
    }

    .theme-toggle button {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      cursor: pointer;
      box-shadow: var(--card-shadow-soft);
    }

    .theme-toggle button:hover {
      transform: rotate(12deg);
    }

    a {
      color: var(--brand-accent);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    #content {
      flex: 1 1 auto;
      display: flex;
      width: 100%;
      max-width: 1300px;
      margin: 0 auto;
      gap: 20px;
      padding: 0 1.5rem 1.5rem;
      overflow: hidden;
    }

    button,
    input[type="range"],
    input[type="number"] {
      cursor: pointer;
      outline: none;
    }

    /* LEFT COLUMN */
    #leftColumn {
      flex: 0 0 40%;
      max-width: 40%;
      display: flex;
      flex-direction: column;
      padding: 16px;
      overflow: hidden;
      background-color: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 18px;
      box-shadow: var(--card-shadow);
    }

    #channelsScrollContainer {
      overflow-y: auto;
      flex: 1;
      padding-right: 10px;
    }

    .channels-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }

    .channels-header .panel-title {
      margin-bottom: 0;
    }

    /* RIGHT COLUMN */
    #rightColumn {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 16px;
      overflow: hidden;
      background-color: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 18px;
      box-shadow: var(--card-shadow);
    }

    .panel-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }

    .panel-title {
      margin: 0;
      font-size: 1.15rem;
      font-weight: 700;
      color: var(--text-main);
      font-family: var(--font-display);
    }

    .panel-subtitle {
      margin: 0.25rem 0 0;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .helper-text {
      margin: 0.35rem 0 0;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      background: var(--surface-strong);
      border: 1px solid var(--border);
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-main);
    }

    /* CHANNEL UI */
    .channel {
      background-color: var(--surface-muted);
      border: 1px solid var(--border);
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 12px;
      width: 100%;
    }

    .channel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .channel-header h3 {
      margin: 0;
      font-size: 1rem;
      margin-right: 10px;
      color: var(--text-main);
    }

    .channel-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .slider-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .slider-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .slider-container {
      display: flex;
      align-items: center;
      white-space: nowrap;
      gap: 5px;
      margin-bottom: 5px;
    }

    .slider-container span {
      white-space: nowrap;
      min-width: 60px;
      text-align: right;
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    input[type="number"] {
      background: var(--card-bg);
      border: 1px solid var(--border);
      color: var(--text-main);
      padding: 4px 8px;
      border-radius: 8px;
      font-family: var(--font-mono);
    }

    .freq-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .channel-canvas {
      width: 100%;
      height: 80px;
      background-color: var(--surface-strong);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-top: 8px;
    }

    /* BUTTONS */
    .btn {
      display: inline-block;
      padding: 8px 18px;
      font-size: 0.9rem;
      color: var(--btn-text-color);
      background-color: var(--btn-bg-color);
      border: 1px solid var(--btn-border-color);
      border-radius: 999px;
      margin-right: 5px;
      text-decoration: none;
      min-width: 80px;
      text-align: center;
      transition: background-color 0.2s, transform 0.2s;
    }

    .btn:hover {
      background-color: var(--btn-bg-hover);
      transform: translateY(-1px);
    }

    .btn:focus-visible,
    input[type="range"]:focus-visible,
    input[type="number"]:focus-visible {
      outline: 2px solid transparent;
      box-shadow: 0 0 0 3px var(--focus-ring);
    }

    #freezeBtn {
      width: 100px;
    }

    /* RANGE SLIDERS */
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 22px;
      background: transparent;
      border: none;
      cursor: pointer;
    }

    input[type="range"]::-webkit-slider-runnable-track {
      width: 100%;
      height: 6px;
      background: var(--slider-bg);
      border-radius: 3px;
      cursor: pointer;
      transition: background 0.3s;
    }

    input[type="range"]:hover::-webkit-slider-runnable-track {
      background: var(--slider-bg-hover);
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--slider-thumb);
      cursor: pointer;
      border: none;
      margin-top: -8px;
      box-shadow: var(--thumb-shadow);
      transition: background 0.3s;
    }

    input[type="range"]::-moz-range-track {
      width: 100%;
      height: 6px;
      background: var(--slider-bg);
      border-radius: 3px;
      cursor: pointer;
      transition: background 0.3s;
    }

    input[type="range"]:hover::-moz-range-track {
      background: var(--slider-bg-hover);
    }

    input[type="range"]::-moz-range-thumb {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--slider-thumb);
      cursor: pointer;
      border: none;
      box-shadow: var(--thumb-shadow);
      transition: background 0.3s;
    }

    /* COMBINED WAVE */
    #combinedWaveContainer {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 10px;
      margin-top: 20px;
      flex: 1 1 auto;
      background: var(--surface-muted);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
    }

    #sumCanvas {
      width: 95%;
      height: 160px;
      background-color: var(--surface-strong);
      border: 2px solid var(--border);
      border-radius: 12px;
      align-self: center;
    }

    #combinedWaveButtons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    #toggleCombinedBtn {
      min-width: 150px;
      text-align: center;
    }

    /* TOP SLIDERS ROW */
    #controlsContainer {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      gap: 20px;
      flex-wrap: wrap;
      background: var(--surface-muted);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
    }

    .info-card {
      background: var(--surface-muted);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: var(--card-shadow-soft);
    }

    .info-card ul {
      margin: 10px 0 0;
      padding-left: 1.2rem;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .info-card li {
      margin-bottom: 6px;
    }

    .controlRow {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      flex: 1 1 180px;
      flex-direction: column;
    }

    .controlRow label {
      margin-bottom: 5px;
      font-size: 0.85rem;
      white-space: nowrap;
      text-align: center;
      color: var(--text-secondary);
    }

    .controlRow span {
      font-size: 0.85rem;
      width: 60px;
      text-align: center;
      margin-top: 5px;
      color: var(--text-main);
    }

    /* VOLUME SLIDER + LABEL */
    #volumeWrapper {
      display: flex;
      align-items: center;
      margin-right: 10px;
      flex-direction: column;
    }

    #volumeWrapper label {
      font-size: 0.85rem;
      margin-bottom: 5px;
      white-space: nowrap;
      text-align: center;
      color: var(--text-secondary);
    }

    #volumeSlider {
      width: 120px;
      max-width: 150px;
    }

    /* FOOTER */
    footer {
      text-align: center;
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin: 10px 0 20px;
      flex: 0 0 auto;
    }

    @media (pointer: coarse) {
      button,
      input,
      select,
      .controlRow button {
        min-height: 44px;
        touch-action: manipulation;
      }

      input[type="range"] {
        height: 44px;
        touch-action: manipulation;
      }

      input[type="range"]::-webkit-slider-runnable-track {
        height: 6px;
      }

      input[type="range"]::-webkit-slider-thumb {
        width: 28px;
        height: 28px;
        margin-top: -11px;
      }

      input[type="range"]::-moz-range-track {
        height: 6px;
      }

      input[type="range"]::-moz-range-thumb {
        width: 28px;
        height: 28px;
      }
    }

    /* Mobile responsive layout */
    @media (max-width: 768px) {
      html, body {
        overflow: auto;
      }

      .page-header {
        width: calc(100% - 1.5rem);
        margin: 0.75rem auto;
        padding: 0.6rem 0.9rem;
        flex-direction: column;
        align-items: flex-start;
      }

      .header-title {
        font-size: 1.2rem;
      }

      .header-subtitle {
        font-size: 0.85rem;
      }

      .header-brand img {
        max-height: 28px;
      }

      #content {
        flex-direction: column;
        padding: 0 0.75rem 1rem;
        gap: 12px;
        overflow: visible;
      }

      #leftColumn {
        flex: none;
        max-width: 100%;
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border);
        padding: 12px;
        max-height: 50vh;
        overflow-y: auto;
      }

      #rightColumn {
        flex: none;
        width: 100%;
        padding: 12px;
        min-height: 300px;
      }

      .channel {
        padding: 10px;
      }

      .channel-header {
        flex-wrap: wrap;
        gap: 8px;
      }

      .slider-container {
        flex-wrap: wrap;
      }

      #globalControlsArea {
        flex-wrap: wrap;
        gap: 8px;
      }

      #chartContainer {
        min-height: 250px;
      }
    }

    @media (max-width: 480px) {
      .header-title {
        font-size: 1rem;
      }

      #leftColumn {
        max-height: 45vh;
      }

      .channel-header h3 {
        font-size: 0.9rem;
      }
    }
  </style>
</head>

<body>

  <header class="page-header">
    <div class="header-brand">
      <a href="https://panphy.github.io/" aria-label="PanPhy Labs home">
        <img src="/assets/panphy.png" alt="PanPhy logo" />
      </a>
      <div>
        <h1 class="header-title">Multi-Channel Tone Generator</h1>
        <p class="header-subtitle">Mix multiple sine tones, visualize the wave, and explore superposition.</p>
      </div>
    </div>
    <div class="header-actions">
      <a class="pill-link" href="/index.html">Back to Home</a>
      <div class="theme-toggle">
        <button id="theme-button" aria-label="Toggle Light/Dark Theme">‚òÄÔ∏è</button>
      </div>
    </div>
  </header>

  <div id="content">
    <!-- LEFT COLUMN: Channels -->
    <div id="leftColumn">
      <div class="channels-header">
        <div>
          <h2 class="panel-title">Channels</h2>
          <p class="panel-subtitle">Add tones, tune their frequency, and toggle play.</p>
          <span class="pill">Hearing range: 20 Hz ‚Äì 20 kHz</span>
        </div>
        <button id="addChannelBtn" class="btn">Add Channel</button>
      </div>
      <p class="helper-text">Tip: Use the number box for precise Hz, then click Play to hear a single channel.</p>
      <div id="channelsScrollContainer"></div>
    </div>

    <!-- RIGHT COLUMN: Controls + Combined Wave -->
    <div id="rightColumn">
      <div class="info-card">
        <h2 class="panel-title">Quick Start</h2>
        <p class="panel-subtitle">Build a mix in three steps.</p>
        <ul>
          <li>Add a channel and set its frequency in Hz.</li>
          <li>Press Play on a channel to preview individual tones.</li>
          <li>Use Play Combined to hear the full mix and see the summed wave.</li>
        </ul>
      </div>

      <div class="panel-header">
        <div>
          <h2 class="panel-title">Master Controls</h2>
          <p class="panel-subtitle">Shape how the mix sounds and how the animation moves.</p>
        </div>
      </div>
      <!-- Sliders: Panning, Log-Time Scale, Zoom In/Out -->
      <div id="controlsContainer">
        <div class="controlRow">
          <label for="panningSlider">L/R Panning:</label>
          <input type="range" id="panningSlider" min="-1" max="1" step="0.01" value="0">
          <span id="panningValue">0.00</span>
        </div>

        <!-- LOGARITHMIC TIME SCALE: slider from -3 => 1 => 10^(-3..1) => 0.001x to 10x -->
        <div class="controlRow">
          <label for="timeScaleSlider">Animation Speed:</label>
          <input type="range" id="timeScaleSlider" min="-3" max="1" step="0.01" value="0">
          <span id="timeScaleValue">1.00x</span>
        </div>

        <div class="controlRow">
          <label for="zoomScaleSlider">Zoom In/Out:</label>
          <input type="range" id="zoomScaleSlider" min="0.01" max="50" step="0.01" value="1">
          <span id="zoomScaleValue">1.00x</span>
        </div>
      </div>

      <div id="combinedWaveContainer">
        <div class="panel-header">
          <div>
            <h2 class="panel-title">Combined Output</h2>
            <p class="panel-subtitle">Watch the total wave and set the global volume.</p>
          </div>
        </div>
        <canvas id="sumCanvas"></canvas>
        <p class="helper-text">Freeze pauses the animation without stopping audio.</p>
        <div id="combinedWaveButtons">
          <div id="volumeWrapper">
            <label for="volumeSlider">Volume:</label>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1">
          </div>
          <button id="toggleCombinedBtn" class="btn">Play Combined</button>
          <button id="freezeBtn" class="btn">Freeze</button>
        </div>
      </div>
    </div>
  </div>

  <footer>
    &copy; <a href="https://panphy.github.io/" target="_blank" rel="noopener noreferrer">PanPhy Labs</a> | <a
      href="https://buymeacoffee.com/panphy" target="_blank" rel="noopener noreferrer">Support
      My Projects</a>
  </footer>
  <script>
    const themeButton = document.getElementById('theme-button');
    const DARK_THEME_KEY = "panphy-dark";
    const LIGHT_THEME_KEY = "panphy-light";

    const currentTheme = localStorage.getItem(DARK_THEME_KEY) ?
      "dark" :
      localStorage.getItem(LIGHT_THEME_KEY) ?
        "light" :
        "light";

    document.documentElement.setAttribute('data-theme', currentTheme);

    function updateButtonEmoji(theme) {
      themeButton.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    updateButtonEmoji(currentTheme);
    window.dispatchEvent(new Event('themechange'));

    themeButton.addEventListener('click', function () {
      let theme = document.documentElement.getAttribute('data-theme');
      if (theme === 'light') {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem(DARK_THEME_KEY, 'true');
        localStorage.removeItem(LIGHT_THEME_KEY);
        updateButtonEmoji('dark');
        window.dispatchEvent(new Event('themechange'));
      } else {
        document.documentElement.setAttribute('data-theme', 'light');
        localStorage.setItem(LIGHT_THEME_KEY, 'true');
        localStorage.removeItem(DARK_THEME_KEY);
        updateButtonEmoji('light');
        window.dispatchEvent(new Event('themechange'));
      }
    });
  </script>
  <script>
    // Gradient text: skip on Brave iOS where background-clip:text is broken
    (function() {
      if (/iP(hone|ad|od)/.test(navigator.userAgent) && navigator.brave) return;
      document.querySelectorAll('.header-title').forEach(function(el) { el.classList.add('gradient-text'); });
    })();
  </script>
</body>

<script>
  /* ========== AUDIO CONTEXT & NODES ========== */
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  const audioCtx = new AudioContext({ latencyHint: 'interactive' });

  // Gains: channels -> masterGain -> volumeGain -> combinedGain -> panner -> destination
  const masterGain = audioCtx.createGain();
  masterGain.gain.value = 1;

  const volumeGain = audioCtx.createGain();
  volumeGain.gain.value = 1;

  const combinedGain = audioCtx.createGain();
  combinedGain.gain.value = 0; // start off

  masterGain.connect(volumeGain);
  volumeGain.connect(combinedGain);

  const stereoPanner = audioCtx.createStereoPanner();

  const saturation = audioCtx.createWaveShaper();
  saturation.curve = makeSoftClipCurve(0.9);
  saturation.oversample = '4x';

  const compressor = audioCtx.createDynamicsCompressor();
  compressor.threshold.value = -24;
  compressor.knee.value = 20;
  compressor.ratio.value = 4;
  compressor.attack.value = 0.003;
  compressor.release.value = 0.25;

  const convolver = audioCtx.createConvolver();
  convolver.buffer = makeImpulseResponse(0.6, 2.5);

  const dryGain = audioCtx.createGain();
  dryGain.gain.value = 0.85;

  const wetGain = audioCtx.createGain();
  wetGain.gain.value = 0.15;

  combinedGain.connect(saturation);
  saturation.connect(compressor);
  compressor.connect(dryGain);
  compressor.connect(convolver);
  convolver.connect(wetGain);
  dryGain.connect(stereoPanner);
  wetGain.connect(stereoPanner);
  stereoPanner.connect(audioCtx.destination);

  /* DOM Elements */
  const addChannelBtn = document.getElementById('addChannelBtn');
  const channelsScrollContainer = document.getElementById('channelsScrollContainer');

  const panningSlider = document.getElementById('panningSlider');
  const panningValue = document.getElementById('panningValue');

  // LOG TIME SCALE: slider from -3..1 => timeScale = 10^sliderValue in [0.001..10]
  const timeScaleSlider = document.getElementById('timeScaleSlider');
  const timeScaleValue = document.getElementById('timeScaleValue');

  const zoomScaleSlider = document.getElementById('zoomScaleSlider');
  const zoomScaleValue = document.getElementById('zoomScaleValue');

  const volumeSlider = document.getElementById('volumeSlider');

  const toggleCombinedBtn = document.getElementById('toggleCombinedBtn');
  const freezeBtn = document.getElementById('freezeBtn');

  const sumCanvas = document.getElementById('sumCanvas');
  const sumCtx = sumCanvas.getContext('2d');

  const channels = [];

  /* States */
  let combinedPlaying = false;
  let isFrozen = false;

  let waveBackgroundColor = '';
  let waveChannelColor = '';
  let waveCombinedColor = '';

  function updateWaveColors() {
    const styles = getComputedStyle(document.documentElement);
    waveBackgroundColor = styles.getPropertyValue('--wave-bg').trim();
    waveChannelColor = styles.getPropertyValue('--wave-channel').trim();
    waveCombinedColor = styles.getPropertyValue('--wave-combined').trim();
  }

  updateWaveColors();
  window.addEventListener('themechange', updateWaveColors);

  // Zoom scale
  let zoomScale = parseFloat(zoomScaleSlider.value);
  zoomScaleValue.textContent = `${zoomScale.toFixed(2)}x`;

  // "timeScale" is derived from the slider (log scale)
  // slider range: -3..1 => timeScale in [0.001..10]
  let timeScale = Math.pow(10, parseFloat(timeScaleSlider.value));
  timeScaleValue.textContent = timeScale.toFixed(3) + 'x';

  // We'll track the total "time offset" for scrolling
  let accumulatedTime = 0;
  let lastTime = null;

  // If we want real-time => timeScale=1 => wave shows actual frequency
  // If timeScale=0.001 => wave is slowed 1000x
  // If timeScale=10 => wave is 10x faster than real time
  // We keep SCALE=1 for straightforward mapping
  const SCALE = 1;

  // We'll keep a small base window in seconds
  const BASE_WINDOW = 0.01;

  /* ========== CREATE & REMOVE CHANNELS ========== */
  function addChannel() {
    const channelIndex = channels.length + 1;

    const oscillator = audioCtx.createOscillator();
    oscillator.type = 'sine';
    oscillator.frequency.value = 440;
    oscillator.start();

    const channelGain = audioCtx.createGain();
    channelGain.gain.value = 0; // start silent
    oscillator.connect(channelGain);
    channelGain.connect(masterGain);

    const channelDiv = document.createElement('div');
    channelDiv.className = 'channel';

    // Header
    const headerDiv = document.createElement('div');
    headerDiv.className = 'channel-header';
    const title = document.createElement('h3');
    title.textContent = `Channel ${channelIndex}`;

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.className = 'btn';
    removeBtn.onclick = () => removeChannel(channelIndex - 1);

    headerDiv.appendChild(title);
    headerDiv.appendChild(removeBtn);

    // Frequency controls
    const sliderGroup = document.createElement('div');
    sliderGroup.className = 'slider-group';

    const sliderLabel = document.createElement('label');
    sliderLabel.className = 'slider-label';
    sliderLabel.textContent = 'Frequency (Hz)';

    const controlsDiv = document.createElement('div');
    controlsDiv.className = 'slider-container freq-controls';

    const freqSlider = document.createElement('input');
    freqSlider.type = 'range';
    freqSlider.min = 15;
    freqSlider.max = 23000;
    freqSlider.value = 440;
    freqSlider.step = 1;
    freqSlider.setAttribute('aria-label', 'Frequency slider');

    const freqNumber = document.createElement('input');
    freqNumber.type = 'number';
    freqNumber.min = 15;
    freqNumber.max = 23000;
    freqNumber.value = 440;
    freqNumber.step = 1;
    freqNumber.setAttribute('aria-label', 'Frequency input');
    freqNumber.style.width = '70px';

    const freqValueLabel = document.createElement('span');
    freqValueLabel.textContent = '440 Hz';

    freqSlider.oninput = () => {
      const freq = parseFloat(freqSlider.value);
      freqNumber.value = freq;
      freqValueLabel.textContent = `${freq} Hz`;
      oscillator.frequency.setValueAtTime(freq, audioCtx.currentTime);
      channels[channelIndex - 1].frequency = freq;
    };
    freqNumber.onchange = () => {
      let val = parseFloat(freqNumber.value);
      if (isNaN(val)) val = 440;
      if (val < 15) val = 15;
      if (val > 23000) val = 23000;
      freqNumber.value = val;
      freqSlider.value = val;
      freqValueLabel.textContent = `${val} Hz`;
      oscillator.frequency.setValueAtTime(val, audioCtx.currentTime);
      channels[channelIndex - 1].frequency = val;
    };

    controlsDiv.appendChild(freqSlider);
    controlsDiv.appendChild(freqNumber);
    controlsDiv.appendChild(freqValueLabel);

    sliderGroup.appendChild(sliderLabel);
    sliderGroup.appendChild(controlsDiv);

    // Play/Pause
    const playPauseBtn = document.createElement('button');
    playPauseBtn.textContent = 'Play';
    playPauseBtn.className = 'btn';
    let playing = false;
    playPauseBtn.onclick = () => {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      playing = !playing;
      channelGain.gain.setValueAtTime(playing ? 1 : 0, audioCtx.currentTime);
      playPauseBtn.textContent = playing ? 'Pause' : 'Play';
    };

    // Wave canvas
    const canvas = document.createElement('canvas');
    canvas.className = 'channel-canvas';
    const ctx = canvas.getContext('2d');

    const channelBody = document.createElement('div');
    channelBody.className = 'channel-body';

    channelBody.appendChild(sliderGroup);
    channelBody.appendChild(playPauseBtn);
    channelBody.appendChild(canvas);

    channelDiv.appendChild(headerDiv);
    channelDiv.appendChild(channelBody);

    channelsScrollContainer.appendChild(channelDiv);

    const channelObj = {
      oscillator,
      channelGain,
      canvas,
      ctx,
      frequency: 440
    };
    channels.push(channelObj);

    resizeCanvas(canvas);
  }

  function removeChannel(index) {
    const ch = channels[index];
    if (!ch) return;
    ch.oscillator.stop();
    ch.oscillator.disconnect();
    ch.channelGain.disconnect();

    channels.splice(index, 1);
    channelsScrollContainer.removeChild(channelsScrollContainer.children[index]);

    Array.from(channelsScrollContainer.children).forEach((child, i) => {
      const title = child.querySelector('h3');
      title.textContent = `Channel ${i + 1}`;
    });
  }

  // ========== DRAW LOOP ==========
  function draw(time) {
    requestAnimationFrame(draw);

    if (!lastTime) {
      lastTime = time;
      return;
    }
    const deltaTime = (time - lastTime) / 1000;
    lastTime = time;

    if (!isFrozen) {
      // timeScale = 10^sliderVal, so timeScale=1 => real time, 0.001 => 1000x slower, etc.
      accumulatedTime += (deltaTime * timeScale) / (SCALE);
    }

    channels.forEach(ch => drawChannelWave(ch, ch.ctx, ch.canvas));
    drawCombinedWave(sumCtx, sumCanvas);
  }

  function drawChannelWave(channel, ctx, canvas) {
    ctx.fillStyle = waveBackgroundColor;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.lineWidth = 2;
    ctx.strokeStyle = waveChannelColor;
    ctx.beginPath();

    const timeWindow = BASE_WINDOW * zoomScale;
    for (let x = 0; x < canvas.width; x++) {
      const fraction = x / (canvas.width - 1);
      // time offset plus fraction of the time window
      const t = accumulatedTime - fraction * timeWindow;
      const val = Math.sin(2 * Math.PI * channel.frequency * t);

      const y = (val * 0.5 + 0.5) * canvas.height;
      if (x === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    ctx.stroke();
  }

  function drawCombinedWave(ctx, canvas) {
    ctx.fillStyle = waveBackgroundColor;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    if (channels.length === 0) return;

    ctx.lineWidth = 2;
    ctx.strokeStyle = waveCombinedColor;
    ctx.beginPath();

    const timeWindow = BASE_WINDOW * zoomScale;
    for (let x = 0; x < canvas.width; x++) {
      const fraction = x / (canvas.width - 1);
      const t = accumulatedTime - fraction * timeWindow;

      let sumVal = 0;
      channels.forEach(ch => {
        sumVal += Math.sin(2 * Math.PI * ch.frequency * t);
      });
      const avgVal = sumVal / channels.length;
      const y = (avgVal * 0.5 + 0.5) * canvas.height;

      if (x === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    ctx.stroke();
  }

  function makeSoftClipCurve(amount) {
    const curve = new Float32Array(44100);
    const k = typeof amount === 'number' ? amount * 30 : 30;
    for (let i = 0; i < curve.length; i++) {
      const x = (i * 2) / curve.length - 1;
      curve[i] = ((1 + k) * x) / (1 + k * Math.abs(x));
    }
    return curve;
  }

  function makeImpulseResponse(duration, decay) {
    const rate = audioCtx.sampleRate;
    const length = rate * duration;
    const impulse = audioCtx.createBuffer(2, length, rate);
    for (let channel = 0; channel < impulse.numberOfChannels; channel++) {
      const channelData = impulse.getChannelData(channel);
      for (let i = 0; i < length; i++) {
        channelData[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, decay);
      }
    }
    return impulse;
  }

  // ========== CONTROLS ==========
  addChannelBtn.addEventListener('click', () => {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    addChannel();
  });

  toggleCombinedBtn.addEventListener('click', () => {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    combinedPlaying = !combinedPlaying;
    combinedGain.gain.setValueAtTime(combinedPlaying ? 1 : 0, audioCtx.currentTime);
    toggleCombinedBtn.textContent = combinedPlaying ? 'Pause Combined' : 'Play Combined';
  });

  freezeBtn.addEventListener('click', () => {
    toggleFreeze();
  });
  document.addEventListener('keydown', e => {
    if (e.code === 'Space') {
      e.preventDefault();
      toggleFreeze();
    }
  });
  function toggleFreeze() {
    isFrozen = !isFrozen;
    freezeBtn.textContent = isFrozen ? 'Unfreeze' : 'Freeze';
    if (isFrozen) {
      masterGain.gain.setValueAtTime(0, audioCtx.currentTime);
    } else {
      masterGain.gain.setValueAtTime(1, audioCtx.currentTime);
    }
  }

  panningSlider.addEventListener('input', () => {
    let panVal = parseFloat(panningSlider.value);
    if (Math.abs(panVal) < 0.05) {
      panVal = 0;
      panningSlider.value = '0';
    }
    stereoPanner.pan.setValueAtTime(panVal, audioCtx.currentTime);
    panningValue.textContent = panVal.toFixed(2);
  });

  // LOG Scale for timeScale: timeScale = 10^(sliderVal)
  timeScaleSlider.addEventListener('input', () => {
    const sliderVal = parseFloat(timeScaleSlider.value);  // -3..1
    timeScale = Math.pow(10, sliderVal);                  // 10^sliderVal => [0.001..10]
    // Display with up to 3 decimal places so 0.001 or 10.0 is shown properly
    timeScaleValue.textContent = timeScale.toFixed(3) + 'x';
  });

  zoomScaleSlider.addEventListener('input', () => {
    zoomScale = parseFloat(zoomScaleSlider.value);
    zoomScaleValue.textContent = `${zoomScale.toFixed(2)}x`;
  });

  volumeSlider.addEventListener('input', () => {
    const volVal = parseFloat(volumeSlider.value);
    volumeGain.gain.setValueAtTime(volVal, audioCtx.currentTime);
  });

  // ========== INIT ==========
  requestAnimationFrame(draw);
  addChannel();

  // ========== RESIZE ==========
  function resizeCanvas(canvas) {
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;
  }

  function debounce(func, wait) {
    let timeout;
    return function (...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  window.addEventListener('resize', debounce(() => {
    channels.forEach(ch => resizeCanvas(ch.canvas));
    resizeCanvas(sumCanvas);
  }, 200));

  resizeCanvas(sumCanvas);
</script>

</html>
